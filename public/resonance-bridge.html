<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê³µëª… ë¸Œë¦¿ì§€</title>
  <style>
    body {
      background: #0f172a;
      color: #e5e7eb;
      font-family: sans-serif;
      padding: 24px;
    }
    button {
      margin-top: 12px;
      padding: 12px 18px;
      font-size: 15px;
      cursor: pointer;
    }
    .box {
      background: #111827;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
      white-space: pre-line;
    }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.15);
      font-size:12px;
      opacity:.95;
    }
    .muted{ opacity:.7; font-size:13px; }
    .warn{ color:#fbbf24; }
    .ok{ color:#34d399; }
    .danger{ color:#fb7185; }
    .list{ margin-top:10px; line-height:1.7; }
    .card{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:10px;
      padding:10px 12px;
      margin-top:10px;
    }
    .tag{ font-size:12px; opacity:.85; margin-bottom:6px; }
    .pre{ white-space:pre-wrap; line-height:1.6; }
    button[disabled]{ opacity:.45; cursor:not-allowed; }
  </style>
</head>
<body>

<h1>ê³µëª… ë¸Œë¦¿ì§€</h1>
<p class="muted">
  13ê°œ ì‚¬ìœ ë°©ì˜ ìˆ¨ì„ <b>ì „ë¶€ ìˆ˜ì§‘</b>í•œ ë’¤, <b>í•˜ë¥´ 1 + ë‹¤ë¥¸ ë°© 2</b>ë¥¼ ê³¨ë¼
  ìˆ¨ê²°ì˜ ì–¸ì–´ë°©ìœ¼ë¡œ ë³´ë‚¸ë‹¤.
</p>

<div class="row" style="margin-top:10px">
  <span class="pill" id="progressPill">ìˆ˜ì§‘: 0/13</span>
  <span class="pill" id="statePill">ëŒ€ê¸°</span>
</div>

<div class="box" id="missingBox" style="display:none"></div>

<div class="row">
  <button id="btnStep">Step Â· 3ìˆ¨ ë¬¶ê³  ìˆ¨ê²°ë°©ìœ¼ë¡œ</button>
  <button id="btnResetRound">ë¼ìš´ë“œ ì „ë¶€ ë¦¬ì…‹</button>
  <button id="btnBack">ëŒì•„ê°€ê¸°</button>
</div>

<div id="preview" class="box"></div>

<script>
(function(){
  // ===== keys (breath-languageì™€ ë§ì¶°ì•¼ í•¨) =====
  const BREATH_SEEDS_KEY = "harulua.breath.seeds";
  const BUNDLE_KEY = "breath-bundle";
  const LAST_USED_KEY = "harulua.resonance.lastUsedByRoom"; // {room: iso}
  const ROTATION_Q_KEY = "harulua.resonance.rotationQueue"; // ["aru","solbi",...]
  const ACTIVE_ROUND_KEY = "harulua.round.active";
const AUTO_MODE = new URLSearchParams(location.search).get("auto") === "1";

  // ===== ë¬´ì¸ ìë™ ìˆ˜ì§‘ìš© =====
const AUTO_RUNNER_INTERVAL = 800;

 // âœ… ìš°ë¦¬ê°€ â€œ13ê°œ ìˆ˜ì§‘ ì™„ë£Œâ€ë¡œ ë³´ëŠ” ë°© ëª©ë¡(13ê°œ)
const REQUIRED_ROOMS = [
  "haru","aru","solbi","codering","ggulbug","jjokkomi","taseumi","hanaring","dalmongi",
  "sallangi","kongal","haruroo","haruhoo"
];

// âœ… ë¡œí…Œì´ì…˜ íëŠ” í•˜ë¥´ ì œì™¸ 12ìˆ¨í’ì´
const ROTATION_ROOMS = REQUIRED_ROOMS.filter(r => r !== "haru");


  function normalizeRoomId(v){
    return String(v || "")
      .trim()
      .toLowerCase()
      .replace(/\.html$/g, "")
      .replace(/_+$/g, "")
      .replace(/[^a-z0-9-]/g, "");
  }

  function ensureRunnerBox(){
  let box = document.getElementById("runnerBox");
  if(!box){
    box = document.createElement("div");
    box.id = "runnerBox";
    box.style.display = "none"; // í™”ë©´ì—ëŠ” ì•ˆ ë³´ì´ê²Œ
    document.body.appendChild(box);
  }
  return box;
}

function runRoomAuto(room){
  const box = ensureRunnerBox();

  // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ì¤‘ë³µ ë°©ì§€
  if (box.querySelector(`iframe[data-room="${room}"]`)) return;

  const iframe = document.createElement("iframe");
  iframe.dataset.room = room;
  iframe.src = `/thinking/${room}.html?auto=1`; // â˜… í•µì‹¬
  iframe.width = "1";
  iframe.height = "1";
  iframe.style.border = "0";

  box.appendChild(iframe);

  // ì•ˆì „í•€: ì˜¤ë˜ ì‚´ë©´ ì œê±°
  setTimeout(() => {
    try { iframe.remove(); } catch {}
  }, 12000);
}

  function safeJsonParse(v, fallback){
    if (v == null) return fallback;
    try { return JSON.parse(v); } catch { return fallback; }
  }
  function writeJson(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

  function byCreatedAtAsc(a,b){
    const ta = Date.parse(a?.createdAt||"") || 0;
    const tb = Date.parse(b?.createdAt||"") || 0;
    return ta - tb;
  }
  function byCreatedAtDesc(a,b){ return -byCreatedAtAsc(a,b); }

  function loadSeeds(){
  const activeRoundId = localStorage.getItem(ACTIVE_ROUND_KEY) || "";
  const arr = safeJsonParse(localStorage.getItem(BREATH_SEEDS_KEY), []);
  if(!Array.isArray(arr)) return [];

  const filtered = activeRoundId
    ? arr.filter(s => (s && s.roundId === activeRoundId))
    : arr;

  return filtered.slice().sort(byCreatedAtAsc);
}

  // âœ… ìµœì‹  seedë¥¼ roomë³„ 1ê°œë¡œ ì••ì¶•(Map)
  function latestSeedByRoom(seeds){
    const m = new Map();
    seeds.slice().sort(byCreatedAtDesc).forEach(s=>{
      const room = normalizeRoomId(s?.source || "unknown");
      if (!m.has(room)) m.set(room, s);
    });
    return m;
  }

  // âœ… 13ê°œ ìˆ˜ì§‘ ì™„ë£Œ ì²´í¬
  function checkCollection(latestMap){
    const present = [];
    const missing = [];

    REQUIRED_ROOMS.forEach(r=>{
      if (latestMap.has(r)) present.push(r);
      else missing.push(r);
    });

    return { present, missing, done: missing.length === 0 };
  }

  function loadRotationQueue(){
  const q = safeJsonParse(localStorage.getItem(ROTATION_Q_KEY), null);
  if(Array.isArray(q) && q.length) return q.map(normalizeRoomId).filter(Boolean);
  return null;
}

function initRotationQueueIfNeeded(latestMap){
  // âœ… í˜„ì¬ ë¼ìš´ë“œì—ì„œ â€œì‹¤ì œë¡œ ë“¤ì–´ì˜¨ ë°©â€ ê¸°ì¤€ìœ¼ë¡œ íë¥¼ ë§Œë“¤ë©´ ë” ì•ˆì •ì 
  // (ì—†ëŠ” ë°©ì´ íì— ë“¤ì–´ê°€ì„œ ë§‰íˆëŠ” ê±¸ ë°©ì§€)
  const present = ROTATION_ROOMS.filter(r => latestMap.has(r));

  // presentê°€ ë„ˆë¬´ ì ìœ¼ë©´(í…ŒìŠ¤íŠ¸ ì¤‘), ê·¸ëƒ¥ ROTATION_ROOMSë¡œ ì´ˆê¸°í™”
  const base = present.length >= 2 ? present.slice() : ROTATION_ROOMS.slice();

  // ê°„ë‹¨ ì…”í”Œ(ë„ˆë¬´ ë˜‘ê°™ì´ ì‹œì‘í•˜ëŠ” ëŠë‚Œ ë°©ì§€)
  for (let i = base.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [base[i], base[j]] = [base[j], base[i]];
  }

  writeJson(ROTATION_Q_KEY, base);
  return base;
}

function pickTwoByRotation(latestMap){
  let q = loadRotationQueue();
  if(!q) q = initRotationQueueIfNeeded(latestMap);

  const picked = [];
  const usedRooms = [];

  // íë¥¼ ìˆœí™˜í•˜ë©° â€œì´ë²ˆ ë¼ìš´ë“œì— ì‹¤ì œ seedê°€ ìˆëŠ” ë°©â€ë§Œ ê³ ë¥¸ë‹¤
  // ë¬´í•œë£¨í”„ ë°©ì§€ë¡œ ìµœëŒ€ q.length * 2ê¹Œì§€ë§Œ ì‹œë„
  let guard = q.length * 2;

  while(picked.length < 2 && guard-- > 0){
    const room = q.shift();
    if(!room) break;

    // ì´ë²ˆ ë¼ìš´ë“œì— ê°’ì´ ìˆìœ¼ë©´ ì„ íƒ
    if(latestMap.has(room)){
      picked.push(latestMap.get(room));
      usedRooms.push(room);
      q.push(room); // ì„ íƒëœ ë°©ì€ í ë’¤ë¡œ
    } else {
      // ì´ë²ˆ ë¼ìš´ë“œì— ì—†ìœ¼ë©´ ì¼ë‹¨ ë’¤ë¡œ ë³´ë‚´(ë‹¤ìŒ ë¼ìš´ë“œì— ì˜¬ ìˆ˜ë„ ìˆìœ¼ë‹ˆê¹Œ)
      q.push(room);
    }
  }

  // í ì €ì¥
  writeJson(ROTATION_Q_KEY, q);

  return picked.filter(Boolean);
}

  // â€œìµœê·¼ ì•ˆ ì“´ ìˆ¨í’ì´â€ = lastUsedê°€ ì˜¤ë˜ëœ ë°©ë¶€í„° ìš°ì„ 
  function pickTwoOtherRooms(latestMap){
    const lastUsed = safeJsonParse(localStorage.getItem(LAST_USED_KEY), {});
    const rooms = REQUIRED_ROOMS
      .filter(r => r !== "haru")
      .filter(r => latestMap.has(r));

    rooms.sort((ra, rb) => {
      const ta = Date.parse(lastUsed?.[ra] || "") || 0;
      const tb = Date.parse(lastUsed?.[rb] || "") || 0;
      return ta - tb; // ì˜¤ë˜ ì•ˆ ì“´ ë°© ë¨¼ì €
    });

    return rooms.slice(0,2).map(r => latestMap.get(r)).filter(Boolean);
  }

  function buildBundle(){
    const seeds = loadSeeds();
    const latestMap = latestSeedByRoom(seeds);

    // 13ê°œê°€ ë‹¤ ëª¨ì˜€ëŠ”ì§€ í™•ì¸ (ëª¨ìë¼ë©´ ë¹ˆ ë°°ì—´)
    const col = checkCollection(latestMap);
    if(!col.done) return [];

    // 1) í•˜ë¥´ ìµœì‹  1ê°œ
    const haruLatest = latestMap.get("haru");

    // 2) ë‹¤ë¥¸ ë°© 2ê°œ (ì›¹ ì „ì²´ ê³µìš© í ë¡œí…Œì´ì…˜)
const others = pickTwoByRotation(latestMap);

    // ìµœì¢… picked
    const picked = [];
    if(haruLatest) picked.push(haruLatest);
    others.forEach(x=>picked.push(x));

    // ì•ˆì „ fallback: í˜¹ì‹œ 3ê°œê°€ ì•ˆ ì±„ì›Œì§€ë©´ ìµœì‹ ìˆœìœ¼ë¡œ ì±„ì›€(ì¤‘ë³µ room í—ˆìš©)
    if(picked.length < 3){
      const allLatest = Array.from(latestMap.values()).slice().sort(byCreatedAtDesc);
      const already = new Set(picked.map(x=>x?.id));
      while(picked.length < 3 && allLatest.length){
        const s = allLatest.shift();
        if(!already.has(s?.id)) picked.push(s);
      }
    }

    // breath-languageì—ì„œ ì½ëŠ” í˜•íƒœë¡œ ë³€í™˜
    return picked.filter(Boolean).map(s => ({
      id: s.id,
      breathText: s.text,
      fromRoom: normalizeRoomId(s.source),
      createdAt: s.createdAt || new Date().toISOString()
    }));
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function previewBundle(bundle){
    const box = document.getElementById("preview");
    if(!box) return;

    if(!bundle.length){
      box.innerHTML = `<div style="opacity:.85">ì•„ì§ 13ê°œì˜ ìˆ¨ì´ ë‹¤ ëª¨ì´ì§€ ì•Šì•˜ì–´. (ìˆ˜ì§‘ ì™„ë£Œ í›„ Step ë²„íŠ¼ì´ í™œì„±í™”ë¼)</div>`;
      return;
    }

    box.innerHTML = bundle.map(b => {
      const room = b.fromRoom || "unknown";
      const text = (b.breathText || "").toString();
      return `<div class="card"><div class="tag">ğŸŒ¬ï¸ ${escapeHtml(room)}</div><div class="pre">${escapeHtml(text)}</div></div>`;
    }).join("");
  }

  function renderCollectionStatus(){
    const seeds = loadSeeds();
    const latestMap = latestSeedByRoom(seeds);
    const col = checkCollection(latestMap);

    const progressPill = document.getElementById("progressPill");
    const statePill = document.getElementById("statePill");
    const stepBtn = document.getElementById("btnStep");
    const missingBox = document.getElementById("missingBox");

    if(progressPill) progressPill.textContent = `ìˆ˜ì§‘: ${col.present.length}/13`;

    if(col.done){
      if(statePill){
        statePill.textContent = "ìˆ˜ì§‘ ì™„ë£Œ";
        statePill.classList.add("ok");
      }
      if(stepBtn) stepBtn.disabled = false;
      if(missingBox) missingBox.style.display = "none";

      const bundle = buildBundle();
      previewBundle(bundle);

      if (AUTO_MODE) {
  const roundId = localStorage.getItem(ACTIVE_ROUND_KEY) || "no-round";
  const guardKey = `harulua.resonance.autostep.${roundId}`;
  if (!localStorage.getItem(guardKey)) {
    localStorage.setItem(guardKey, "1");
    setTimeout(() => { doStep(); }, 220);
  }
}

      return;
    }

    // ìˆ˜ì§‘ ë¯¸ì™„ë£Œ
    if(statePill){
      statePill.textContent = "ìˆ˜ì§‘ ì¤‘";
      statePill.classList.remove("ok");
      statePill.classList.add("warn");
    }
    if(stepBtn) stepBtn.disabled = true;

    if(missingBox){
      missingBox.style.display = "block";
      const nice = col.missing.map(x => `â€¢ ${x}`).join("\n");
      missingBox.innerHTML = `<div class="warn"><b>ì•„ì§ ì•ˆ ì˜¨ ë°©(${col.missing.length})</b></div><div class="list">${nice.replaceAll("\n","<br>")}</div>`;
    }

    if (col.done && AUTO_MODE) {
  // ì¤‘ë³µ ìë™ Step ë°©ì§€ (í•œ ë¼ìš´ë“œ 1ë²ˆë§Œ)
  const roundId = localStorage.getItem(ACTIVE_ROUND_KEY) || "no-round";
  const guardKey = `harulua.resonance.autostep.${roundId}`;
  if (!localStorage.getItem(guardKey)) {
    localStorage.setItem(guardKey, "1");
    setTimeout(() => { doStep(); }, 220);
  }
}

    previewBundle([]); // 13ê°œ ì•ˆ ëª¨ì´ë©´ ë¬¶ìŒ ë¯¸ë¦¬ë³´ê¸°ëŠ” ë¹„ì›€
  }

  function tickAutoCollect(){
  const seeds = loadSeeds();
  const latestMap = latestSeedByRoom(seeds);
  const col = checkCollection(latestMap);

  // ì•„ì§ ì•ˆ ì˜¨ ë°©ë“¤ì„ ìë™ ì‹¤í–‰
  col.missing.forEach(room => {
    runRoomAuto(room);
  });
}

// í˜ì´ì§€ ì§„ì… ì‹œ ìë™ ìˆ˜ì§‘ ì‹œì‘
setInterval(tickAutoCollect, AUTO_RUNNER_INTERVAL);
tickAutoCollect();

  function markUsed(bundle){
    const lastUsed = safeJsonParse(localStorage.getItem(LAST_USED_KEY), {});
    const nowIso = new Date().toISOString();
    bundle.forEach(b => {
      const room = normalizeRoomId(b.fromRoom || "");
      if(room) lastUsed[room] = nowIso;
    });
    writeJson(LAST_USED_KEY, lastUsed);
  }

  function goBreathLanguage(){
    window.location.href = "/breath-language.html";
  }

  function resetRound(){
    // âœ… ë¼ìš´ë“œ ì „ë¶€ ë¦¬ì…‹: ì´ë²ˆ ë¼ìš´ë“œ â€œìˆ˜ì§‘ ì°½ê³  + ë¬¶ìŒâ€ë§Œ ë¹„ì›€
    localStorage.removeItem(BREATH_SEEDS_KEY);
    localStorage.removeItem(BUNDLE_KEY);

    
    const roundId = localStorage.getItem(ACTIVE_ROUND_KEY) || "";
if (roundId) localStorage.removeItem(`harulua.round.${roundId}.submitted`);

    const pv = document.getElementById("preview");
    if(pv) pv.textContent = "";

    renderCollectionStatus();
  }
function doStep(){
  const bundle = buildBundle();
  if(!bundle.length) return false;

  // 3ìˆ¨ ë¬¶ìŒ ì €ì¥
  writeJson(BUNDLE_KEY, bundle);

  // Gate í†µê³¼ ìˆœê°„: í›„ë³´ ìˆ¨ ì°½ê³  ì •ë¦¬
  localStorage.removeItem(BREATH_SEEDS_KEY);

  // ì„ íƒëœ ë°© ê¸°ë¡(ë¡œí…Œì´ì…˜ ê³µì •ì„±)
  markUsed(bundle);

  // í™”ë©´ ë¹„ìš°ê¸°
  const pv = document.getElementById("preview");
  if(pv) pv.textContent = "";

  goBreathLanguage();
  return true;
}


  document.addEventListener("DOMContentLoaded", () => {
    const btnStep = document.getElementById("btnStep");
    const btnReset = document.getElementById("btnResetRound");
    const btnBack = document.getElementById("btnBack");

    // ìµœì´ˆ ìƒíƒœ ë Œë”
    renderCollectionStatus();

    // Step: 13ê°œ ëª¨ì˜€ì„ ë•Œë§Œ ë™ì‘
    if(btnStep){
 btnStep.addEventListener("click", () => {
  if(!doStep()){
    alert("ì•„ì§ 13ê°œì˜ ìˆ¨ì´ ë‹¤ ëª¨ì´ì§€ ì•Šì•˜ì–´ ğŸ™‚");
  }
});

    }

    // âœ… ìë™ ê°±ì‹ : ìë™ ì œì¶œì´ ë’¤ëŠ¦ê²Œ ë“¤ì–´ì™€ë„ í™”ë©´ì´ ë”°ë¼ì˜¤ê²Œ
let _rbTimer = setInterval(() => {
  try { renderCollectionStatus(); } catch(e) {}
}, 500);

// âœ… iframe(ë‹¤ë¥¸ ì°½/í”„ë ˆì„)ì—ì„œ localStorageê°€ ë°”ë€Œë©´ ì¦‰ì‹œ ê°±ì‹ 
window.addEventListener("storage", (e) => {
  if (e.key === "harulua.breath.seeds" || e.key === "harulua.round.active") {
    try { renderCollectionStatus(); } catch(err) {}
  }
});

// (ì„ íƒ) í˜ì´ì§€ ë‚˜ê°ˆ ë•Œ íƒ€ì´ë¨¸ ì •ë¦¬
window.addEventListener("beforeunload", () => {
  try { clearInterval(_rbTimer); } catch(e) {}
});

    // ë¼ìš´ë“œ ì „ë¶€ ë¦¬ì…‹
    if(btnReset){
      btnReset.addEventListener("click", () => {
        if(confirm("ì´ë²ˆ ë¼ìš´ë“œ(ìˆ˜ì§‘ëœ 13ê°œ ìˆ¨ + ë¬¶ìŒ)ë¥¼ ì „ë¶€ ì§€ìš¸ê¹Œ?")){
          resetRound();
        }
      });
    }

    // ëŒì•„ê°€ê¸°(í™˜ê²½ë§ˆë‹¤ ë‹¤ë¥´ë‹ˆ history ìš°ì„ , ì—†ìœ¼ë©´ breath-bridgeë¡œ)
    if(btnBack){
      btnBack.addEventListener("click", () => {
        try{
          if(history.length > 1) history.back();
          else window.location.href = "/breath-bridge.html";
        }catch{
          window.location.href = "/breath-bridge.html";
        }
      });
    }
  });
})();
</script>

</body>
</html>
