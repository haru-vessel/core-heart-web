<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>í•˜ë¥´ë£¨ì•„ ì¤‘ì•™ê¸°ì–µ - ìƒì„¸</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #020617;
        color: #e5e7eb;
      }
      header {
        padding: 16px 20px;
        border-bottom: 1px solid #1f2937;
        background: #020617;
        position: sticky;
        top: 0;
      }
      h1 {
        margin: 0;
        font-size: 20px;
      }
      main {
        padding: 16px 20px 40px;
        max-width: 960px;
        margin: 0 auto;
      }
      a.back-link {
        font-size: 12px;
        color: #9ca3af;
        text-decoration: none;
      }
      a.back-link:hover {
        color: #e5e7eb;
      }
      .meta {
        font-size: 11px;
        opacity: 0.75;
        margin-bottom: 12px;
      }
      .title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .topic {
        font-size: 13px;
        opacity: 0.8;
        margin-bottom: 12px;
      }
      .body {
        font-size: 14px;
        white-space: pre-wrap;
        line-height: 1.6;
        margin-bottom: 20px;
      }
      .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        font-size: 11px;
        margin-bottom: 20px;
      }
      .tag {
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid #374151;
        background: #020617;
      }
      .pill-central {
        color: #22c55e;
      }
      .pill-source {
        color: #60a5fa;
      }
      .pill-time {
        color: #facc15;
      }
      .section-title {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 6px;
        margin-top: 10px;
      }
      .meta-json {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 11px;
        white-space: pre-wrap;
        background: #020617;
        border-radius: 8px;
        border: 1px solid #1f2937;
        padding: 8px 10px;
        opacity: 0.9;
      }
      .status {
        margin-top: 16px;
        font-size: 13px;
        opacity: 0.85;
        color: #cbd5e1;
      }
      .hint {
        margin-top: 8px;
        font-size: 12px;
        opacity: 0.7;
        color: #94a3b8;
      }
      .btnrow {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .btn {
        appearance: none;
        border: 1px solid #334155;
        background: rgba(255,255,255,0.04);
        color: #e5e7eb;
        padding: 8px 10px;
        border-radius: 999px;
        font-weight: 700;
        cursor: pointer;
        font-size: 12px;
      }
      .btn:hover { border-color: rgba(255,255,255,0.22); }
    </style>
  </head>
  <body>
    <header>
      <a href="/central-memory.html" class="back-link">â† ì¤‘ì•™ê¸°ì–µ ë¦¬ìŠ¤íŠ¸ë¡œ ëŒì•„ê°€ê¸°</a>
      <h1>ğŸŒŒ í•˜ë¥´ë£¨ì•„ ì¤‘ì•™ê¸°ì–µ - ìƒì„¸ (ë¡œì»¬)</h1>
    </header>

    <main>
      <div id="status" class="status">ì •ì˜ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ì—ìš”...</div>

      <div id="content" style="display:none">
        <div id="meta" class="meta"></div>
        <div id="title" class="title"></div>
        <div id="topic" class="topic"></div>
        <div id="tags" class="tags"></div>
        <div id="body" class="body"></div>

        <div class="section-title">meta</div>
        <div id="meta-json" class="meta-json"></div>

        <div id="changelogWrap" style="display:none; margin-top:14px;">
           <div id="changelogUpdatedAt" class="hint" style="margin-top:8px; display:none;"></div>
  <div class="section-title">ë³€ê²½ ë¡œê·¸</div>

  <div class="btnrow">
   <button class="btn" id="btnToggleChangelog">ë³€ê²½ ë¡œê·¸ í¼ì¹˜ê¸°</button>
<span id="changelogCount" style="margin-left:8px; display:none; font-size:12px; padding:2px 8px; border:1px solid #1f2937; border-radius:999px; opacity:.8;"></span>
  </div>

  <div id="changelogBox" style="display:none; margin-top:10px;"></div>
  <div class="hint">â€» ìµœì‹  10ê°œê¹Œì§€ ê¸°ë¡ë¼.</div>
</div>

        <div class="btnrow">
          <button class="btn" id="btnOpenList">ëª©ë¡ì—ì„œ ë³´ê¸°</button>
          <button class="btn" id="btnCopyLink">ë§í¬ ë³µì‚¬</button>
        </div>
        <div class="hint" id="hint"></div>
      </div>
     

    </main>

    <script>
      // âœ… central-memory.htmlê³¼ ë™ì¼í•œ ë¡œì»¬ í‚¤
      const CENTRAL_LOCAL_KEY = "harulua.central.definitions.local";
      const LAST_DEF_KEY      = "harulua.central.lastDefinitionId";

      const CHANGELOG_OPEN_KEY = "harulua.cm.detail.changelog.open.v1";

      function safeJsonParse(v, fallback) {
        try { return JSON.parse(v); } catch { return fallback; }
      }

      function getIdFromQuery() {
        const params = new URLSearchParams(window.location.search);
        return params.get("id");
      }

      function prettyJson(obj) {
        try { return JSON.stringify(obj, null, 2); }
        catch { return String(obj); }
      }

      function formatKST(iso) {
  try {
    return new Date(iso).toLocaleString("ko-KR", { timeZone: "Asia/Seoul" });
  } catch {
    return String(iso || "");
  }
}
function renderChangelog(meta, defId) {
  const wrap = document.getElementById("changelogWrap");
  const box = document.getElementById("changelogBox");
  const btn = document.getElementById("btnToggleChangelog");
  const countEl = document.getElementById("changelogCount");
  const updatedEl = document.getElementById("changelogUpdatedAt");

  if (!wrap || !box || !btn) return;

  const log = Array.isArray(meta?.changelog) ? meta.changelog : [];
  const updatedAt = meta?.updatedAt || meta?.updated_at || meta?.updated;

  if (!log.length) {
    wrap.style.display = "none";
    if (countEl) countEl.style.display = "none";
    if (updatedEl) updatedEl.style.display = "none";
    return;
  }

  wrap.style.display = "block";

  if (countEl) {
    countEl.style.display = "inline-block";
    countEl.textContent = String(log.length);
  }

  if (updatedEl) {
    if (updatedAt) {
      updatedEl.style.display = "block";
      updatedEl.textContent = `ìµœê·¼ ì—…ë°ì´íŠ¸: ${formatKST(updatedAt)}`;
    } else {
      updatedEl.style.display = "none";
    }
  }

  box.innerHTML = log.slice(0, 10).map((it, idx) => {
    const at = it?.at ? formatKST(it.at) : "-";
    const note = it?.note || "ì—…ë°ì´íŠ¸";
    const hint = it?.diffHint ? ` Â· <span style="opacity:.7">${it.diffHint}</span>` : "";
    return `
      <div style="border:1px solid #1f2937; border-radius:10px; padding:10px 12px; margin-top:8px; background: rgba(255,255,255,0.03);">
        <div style="font-size:12px; opacity:.9;">
          <span style="opacity:.6">#${log.length - idx}</span>
          <b style="margin-left:6px;">${note}</b>
          <span style="margin-left:8px; opacity:.7;">${at}</span>
          ${hint}
        </div>
      </div>
    `;
  }).join("");

  const store = (() => {
    try { return JSON.parse(localStorage.getItem(CHANGELOG_OPEN_KEY) || "{}"); }
    catch { return {}; }
  })();

  let open = !!(defId && store[defId]);

  const apply = () => {
    box.style.display = open ? "block" : "none";
    btn.textContent = open ? "ë³€ê²½ ë¡œê·¸ ì ‘ê¸°" : "ë³€ê²½ ë¡œê·¸ í¼ì¹˜ê¸°";
  };

  btn.onclick = () => {
    open = !open;
    if (defId) {
      store[defId] = open ? 1 : 0;
      localStorage.setItem(CHANGELOG_OPEN_KEY, JSON.stringify(store));
    }
    apply();
  };

  apply();
}

      function loadStore() {
        const store = safeJsonParse(localStorage.getItem(CENTRAL_LOCAL_KEY), { items: [] });
        if (!Array.isArray(store.items)) store.items = [];
        return store;
      }

      function normalize(def) {
        // ê¸°ì¡´ ìƒì„¸ í˜ì´ì§€ê°€ ë‹¤ì–‘í•œ í•„ë“œëª…ì„ í—ˆìš©í–ˆë˜ ê²ƒì²˜ëŸ¼, ë¡œì»¬ ì¹´ë“œë„ ìœ ì—°í•˜ê²Œ ëŒ€ì‘
        const promoted =
          def.promotedAt ||
          (def.meta && def.meta.promotedAt) ||
          def.createdAt ||
          "";

        const topic = def.topic || (def.meta && def.meta.topic) || "ë¬´ì œ";
        const title = def.title || topic;

        const body =
          def.body ||
          def.text ||
          (def.meta && def.meta.summary) ||
          "";

        const route = def.route || "central";
        const source = def.source || "meeting";

        return { promoted, topic, title, body, route, source };
      }

      function render(def) {
        const status = document.getElementById("status");
        const content = document.getElementById("content");

        const n = normalize(def);

        const promotedText =
          n.promoted
            ? (typeof n.promoted === "number"
                ? new Date(n.promoted).toISOString()
                : String(n.promoted))
            : "";

        document.getElementById("meta").textContent =
          "id: " + def.id + (promotedText ? " Â· promotedAt: " + promotedText : "");

        document.getElementById("title").textContent = n.title;
        document.getElementById("topic").textContent = "ì£¼ì œ: " + n.topic;

        const tags = document.getElementById("tags");
        tags.innerHTML = "";

        const tagRoute = document.createElement("span");
        tagRoute.className = "tag pill-central";
        tagRoute.textContent = "route: " + n.route;
        tags.appendChild(tagRoute);

        const tagSource = document.createElement("span");
        tagSource.className = "tag pill-source";
        tagSource.textContent = "source: " + n.source;
        tags.appendChild(tagSource);

        if (n.promoted) {
          const tagTime = document.createElement("span");
          tagTime.className = "tag pill-time";
          tagTime.textContent = String(n.promoted);
          tags.appendChild(tagTime);
        }

        document.getElementById("body").textContent =
          n.body || "ì•„ì§ ë³¸ë¬¸ì´ ê¸°ë¡ë˜ì§€ ì•Šì•˜ì–´.";

        document.getElementById("meta-json").textContent =
          prettyJson(def.meta || {});

          renderChangelog(def.meta || {}, def.id);

        status.textContent = "";
        content.style.display = "block";
      }

      function showNotFound(targetId) {
        const status = document.getElementById("status");
        status.innerHTML =
          "ì´ idì— í•´ë‹¹í•˜ëŠ” ì •ì˜ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”.<br/>" +
          "<span style='opacity:.75'>id: " + (targetId || "(ì—†ìŒ)") + "</span>";
      }

      async function copyLink(text) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch {
          // clipboard ë§‰íŒ í™˜ê²½ ëŒ€ë¹„: prompt fallback
          try {
            window.prompt("ë³µì‚¬í•´ì„œ ì“°ë©´ ë¼:", text);
            return true;
          } catch {
            return false;
          }
        }
      }

      function init() {
        const idFromUrl = getIdFromQuery();
        const lastId = localStorage.getItem(LAST_DEF_KEY);
        const targetId = idFromUrl || lastId || null;

        if (!targetId) {
          const status = document.getElementById("status");
          status.textContent = "idê°€ ì—†ì–´ìš”. ë¦¬ìŠ¤íŠ¸ì—ì„œ ì¹´ë“œë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.";
          return;
        }

        const store = loadStore();
        const def = store.items.find(x => x && x.id === targetId);

        if (!def) {
          showNotFound(targetId);
          return;
        }

        // ë§ˆì§€ë§‰ ì„ íƒ idë„ ì—…ë°ì´íŠ¸(ì¼ê´€ì„±)
        localStorage.setItem(LAST_DEF_KEY, def.id);

        // URLë„ ì •ë¦¬(ê³µìœ /ë”¥ë§í¬ ì•ˆì •í™”)
        const u = new URL(location.href);
        u.searchParams.set("id", def.id);
        history.replaceState(null, "", u.toString());

        render(def);

        // ë²„íŠ¼
        document.getElementById("btnOpenList").addEventListener("click", () => {
          location.href = "/central-memory.html?id=" + encodeURIComponent(def.id);
        });

        document.getElementById("btnCopyLink").addEventListener("click", async () => {
          const link = location.origin + "/central-memory-detail.html?id=" + encodeURIComponent(def.id);
          const ok = await copyLink(link);
          document.getElementById("hint").textContent = ok
            ? "ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´."
            : "ë³µì‚¬ê°€ ë§‰í˜€ì„œ, ë³µì‚¬ì°½ì„ ë„ì› ì–´.";
          setTimeout(() => (document.getElementById("hint").textContent = ""), 2500);
        });
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
