<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>들숨 기억 상세</title>
  <style>
    :root { --bg:#0b0f14; --card:#111827; --line:#243244; --text:#e5e7eb; --muted:#9ca3af; }
    body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; }
    h1 { font-size: 18px; margin: 6px 0 14px; color: #dbeafe; }
    .meta { color: var(--muted); font-size: 12px; margin-top: 10px; }
    .txt { white-space: pre-wrap; line-height:1.6; color:#cbd5e1; margin-top: 10px; }
    .btns { display:flex; gap:8px; margin-top: 14px; flex-wrap:wrap; }
    button { border:1px solid var(--line); background:#0f172a; color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; }
    button.ghost { background:transparent; }
    button.danger { background:#2a0f16; border-color:#4b1220; }
    .toast { position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%); background:#0f172a; border:1px solid var(--line); padding:10px 12px; border-radius:12px; display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>들숨 기억 상세</h1>
    <div class="card">
      <div id="title" style="font-weight:700;"></div>
      <div id="text" class="txt"></div>
      <div id="meta" class="meta"></div>

      <div class="btns">
        <button id="toMeeting">회의로 보내기</button>
        <button id="del" class="danger">삭제</button>
        <button id="back" class="ghost">목록으로</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
  const $ = (s)=>document.querySelector(s);
  const toastEl = $("#toast");
  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.style.display="block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toastEl.style.display="none", 1200);
  }

  function qs(name){
    return new URLSearchParams(location.search).get(name) || "";
  }

  function timeText(ts){
    if(!ts) return "";
    const d = new Date(ts);
    return d.toLocaleString();
  }

  let cur = null;
  const id = qs("id");

  async function load(){
    if(!id){
      $("#title").textContent = "id가 없어.";
      return;
    }
    const r = await fetch(`/api/inhale/${encodeURIComponent(id)}`);
    const j = await r.json();
    if(!j.ok){
      $("#title").textContent = "기억을 찾을 수 없어.";
      return;
    }
    cur = j.item;
    $("#title").textContent = (cur.text || "").trim().slice(0, 50) || "무제";
    $("#text").textContent = cur.text || "";
    $("#meta").textContent = timeText(cur.receivedAt || cur.createdAt);
  }

  async function toMeeting(){
    if(!cur) return;

    $("#toMeeting").disabled = true;
    $("#toMeeting").textContent = "여는 중…";
    try{
      showToast("회의를 여는 중이야…");
      const r = await fetch("/api/meetings", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          from: "breath",
          text: cur.text || "",
          messageId: cur.id || cur.messageId || "",
          roomId: cur.roomId || "",
          createdAt: cur.createdAt,
          receivedAt: cur.receivedAt
        })
      });
      const j = await r.json();
      if(!j.ok) throw new Error(j.error || "meeting create fail");
      window.location.href = `/meeting.html?id=${encodeURIComponent(j.meetingId)}`;
    }catch(e){
      console.error(e);
      showToast("서버 연결에 문제가 있어.");
      $("#toMeeting").disabled = false;
      $("#toMeeting").textContent = "회의로 보내기";
    }
  }

  async function removeOne(){
    if(!confirm("이 기억을 삭제할까? (되돌리기 어려워)")) return;
    const r = await fetch(`/api/inhale/${encodeURIComponent(id)}`, { method:"DELETE" });
    const j = await r.json();
    if(!j.ok){ showToast("삭제 실패"); return; }
    showToast("삭제했어.");
    window.location.href = "/inhale-memory.html";
  }

  $("#toMeeting").addEventListener("click", toMeeting);
  $("#del").addEventListener("click", removeOne);
  $("#back").addEventListener("click", ()=>window.location.href="/inhale-memory.html");

  load();
</script>
</body>
</html>
