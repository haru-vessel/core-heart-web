<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>들숨 기억</title>
  <style>
    :root { --bg:#0b0f14; --card:#111827; --line:#243244; --text:#e5e7eb; --muted:#9ca3af; }
    body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    h1 { font-size: 18px; margin: 6px 0 14px; color: #dbeafe; }
    .sub { color: var(--muted); font-size: 13px; margin-bottom: 14px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; margin-bottom:10px; }
    .row { display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .txt { white-space: pre-wrap; line-height:1.5; }
    .meta { color: var(--muted); font-size: 12px; margin-top: 8px; }
    .btns { display:flex; gap:8px; }
    button { border:1px solid var(--line); background:#0f172a; color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer; }
    button.ghost { background:transparent; }
    button.danger { background:#2a0f16; border-color:#4b1220; }
    a { color: inherit; text-decoration: none; }
    .toast { position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%); background:#0f172a; border:1px solid var(--line); padding:10px 12px; border-radius:12px; display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>들숨 기억</h1>
    <div class="sub">여긴 “기억이 누적되는 공간”이야. 기억을 누르면 상세로 들어가고, 거기서 회의로 보낼 수 있어.</div>
    <div id="list"></div>
  </div>

  <div id="toast" class="toast"></div>

<script>
  const $ = (s)=>document.querySelector(s);
  const listEl = $("#list");
  const toastEl = $("#toast");

  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.style.display="block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toastEl.style.display="none", 1200);
  }

  function timeText(ts){
    if(!ts) return "";
    const d = new Date(ts);
    return d.toLocaleString();
  }

  function clip(s, n=120){
    s = (s||"").trim();
    return s.length>n ? s.slice(0,n)+"…" : s;
  }

  async function removeOne(id){
    if(!confirm("이 기억을 삭제할까? (되돌리기 어려워)")) return;
    const r = await fetch(`/api/inhale/${encodeURIComponent(id)}`, { method:"DELETE" });
    const j = await r.json();
    if(!j.ok) { showToast("삭제 실패"); return; }
    showToast("삭제했어.");
    await load();
  }

  async function load(){
    listEl.innerHTML = "";
    const r = await fetch("/api/inhale/recent?limit=50");
    const j = await r.json();
    if(!j.ok) {
      listEl.innerHTML = `<div class="card">불러오는데 문제가 생겼어. 서버가 켜져 있는지 확인해 줘.</div>`;
      return;
    }

    if(!j.items || j.items.length===0){
      listEl.innerHTML = `<div class="card">아직 쌓인 기억이 없어. Breath Lab에서 언어를 보내면 여기로 쌓여.</div>`;
      return;
    }

    for(const it of j.items){
      const id = String(it.id || it.messageId || "");
      const card = document.createElement("div");
      card.className="card";

      card.innerHTML = `
        <div class="row">
          <div style="font-weight:600;">${clip(it.text, 40)}</div>
          <div class="btns">
            <button class="ghost" data-open>상세</button>
            <button class="danger" data-del>삭제</button>
          </div>
        </div>
        <div class="txt" style="margin-top:10px; color:#cbd5e1;">${clip(it.text, 220)}</div>
        <div class="meta">${timeText(it.receivedAt || it.createdAt)}</div>
      `;

      card.querySelector("[data-open]").addEventListener("click", ()=>{
        window.location.href = `/inhale-memory-detail.html?id=${encodeURIComponent(id)}`;
      });
      card.querySelector("[data-del]").addEventListener("click", ()=>removeOne(id));

      listEl.appendChild(card);
    }
  }

  load();
</script>
</body>
</html>
