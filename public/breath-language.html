<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìˆ¨ê²°ì˜ ì–¸ì–´</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#111b2e;
      --card: rgba(255,255,255,0.06);
      --line: rgba(255,255,255,0.12);
      --text:#e5e7eb;
      --muted:rgba(229,231,235,0.75);
      --blue:#60a5fa;
      --ok:#34d399;
      --warn:#f59e0b;
      --danger:#fb7185;
    }
    body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    a{color:var(--blue); text-decoration:none;}
    .wrap{max-width:920px; margin:18px auto; padding:0 14px;}
    .top{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:14px;}
    .title{font-size:22px; font-weight:900;}
    .sub{color:var(--muted); font-size:13px;}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border:1px solid var(--line); border-radius:16px; padding:16px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .btn{
      appearance:none; border:1px solid var(--line);
      background:var(--card); color:var(--text);
      padding:10px 12px; border-radius:999px;
      font-weight:800; cursor:pointer;
    }
    .btn:hover{border-color:rgba(255,255,255,0.22);}
    .btn.primary{background:rgba(96,165,250,0.18); border-color:rgba(96,165,250,0.35);}
    .btn.ok{background:rgba(52,211,153,0.14); border-color:rgba(52,211,153,0.35);}
    .status{margin-top:10px; color:var(--muted); font-size:13px;}
    .box{
      margin-top:12px;
      background:rgba(0,0,0,0.18);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .h{font-weight:900; margin:2px 0 10px;}
    textarea{
      width:100%;
      background:rgba(0,0,0,0.22);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      min-height:120px;
      resize:vertical;
      line-height:1.7;
    }
    .mini{font-size:12px; color:var(--muted);}
    .list{display:grid; gap:10px; margin-top:10px;}
    .cand{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .tag{font-size:12px; color:var(--muted); margin-bottom:6px;}
    .pre{white-space:pre-wrap; word-break:break-word; line-height:1.7; font-size:15px;}
.pickrow{display:flex; gap:10px; align-items:flex-start;}
    .source{
  font-size: 12px;
  opacity: .7;
  margin-bottom: 6px;
}

  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">ìˆ¨ê²°ì˜ ì–¸ì–´</div>
        <div class="sub">ì‚¬ìœ ë°©ì—ì„œ ë“¤ì–´ì˜¨ ìˆ¨ë“¤ì„ ëª¨ì•„, íšŒì˜ë¡œ ë³´ë‚¼ â€œí•©ì˜ë¬¸(ì¡°í•©)â€ì„ ë§Œë“ ë‹¤.</div>
      </div>
      <div class="row">
        <a class="btn" href="/console.html">â† ë©”ì¸</a>
        <a class="btn" href="/meeting.html">íšŒì˜ë¡œ</a>
        
      </div>
    </div>

    <div class="panel">
      <div class="row">
        <button class="btn primary" id="btnLoad">ìˆ¨ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn ok" id="btnCompose">í•©ì˜ë¬¸ ë§Œë“¤ê¸°</button>
        <button class="btn ok" id="btnSendMeeting">íšŒì˜ë¡œ ë³´ë‚´ê¸°</button>
      </div>

      <div class="status" id="status">ëŒ€ê¸° ì¤‘â€¦</div>

      <div class="box">
        <div class="h">í•©ì˜ë¬¸(ìš”ì•½ summary)</div>
        <div class="mini">íšŒì˜ ë¦¬ìŠ¤íŠ¸ì—ì„œ í•œ ì¤„ë¡œ ë³´ì´ëŠ” ë¬¸ì¥</div>
        <textarea id="summaryTa" placeholder="í•©ì˜ë¬¸ í•œ ì¤„ì´ ì—¬ê¸°ì— ë§Œë“¤ì–´ì ¸."></textarea>
      </div>

      <div class="box">
        <div class="h">íšŒì˜ ë³¸ë¬¸(body)</div>
        <div class="mini">meeting.htmlì˜ â€˜íšŒì˜ ë³¸ë¬¸â€™ìœ¼ë¡œ ê·¸ëŒ€ë¡œ ë“¤ì–´ê°€.</div>
        <textarea id="bodyTa" placeholder="í›„ë³´ ìˆ¨ë“¤ì„ ì¡°í•©í•´ì„œ ë³¸ë¬¸ì´ ë§Œë“¤ì–´ì ¸."></textarea>
      </div>

      <div class="box">
        <div class="h">ì˜¤ëŠ˜ì˜ 3ìˆ¨</div>
        <div class="mini">ê³µëª… ë¸Œë¦¿ì§€ì—ì„œ ê³ ë¥¸ 3ìˆ¨ì´ì•¼. ì—¬ê¸°ì„œ ë‹¤ë“¬ê³  íšŒì˜ë¡œ ë³´ë‚´.</div>
        <div id="candList" class="list"></div>
      </div>
    </div>
  </div>

<script>
  // ===== keys =====
  const BREATH_SEEDS_KEY   = "harulua.breath.seeds"; 
  const LOCAL_MEETINGS_KEY = "harulua.meetings";
  const LAST_MEETING_KEY   = "harulua.lastMeetingId";
const AUTO_MODE = true;
const RETURN_TO_APP = true; // ì•± ìë™ ë³µê·€ê¹Œì§€ ê¸°ë³¸ì´ë©´ true


function flushBreathSeeds(){
  const raw = localStorage.getItem(BREATH_SEEDS_KEY);
  let count = 0;

  try {
    const arr = JSON.parse(raw || "[]");
    if (Array.isArray(arr)) count = arr.length;
  } catch {}

  localStorage.removeItem(BREATH_SEEDS_KEY);
  return count;
}

 function safeJsonParse(v, fallback){
  if (v == null) return fallback;   // âœ… ì´ í•œ ì¤„ì´ í•µì‹¬
  try { return JSON.parse(v); } catch { return fallback; }
}
function normalizeText(s){
  return String(s || "")
    .replace(/\s+/g, " ")
    .replace(/^[-â€¢]\s*/g, "")   // ì• ê¸°í˜¸ ì œê±°
    .trim();
}

function pullDictionaryParenWithPieces(text){
  const dictPieces = [];
  const s = (text || "").toString();
  const re = /\(([^()]*?(ì˜ì‚¬ì†Œí†µ|ì‚¬ì „|ëœ»|ì •ì˜)[^()]*)\)/g;

  let out = s;
  let m;
  while ((m = re.exec(s)) !== null) {
    const inner = (m[1] || "").trim();
    if (inner) dictPieces.push(inner);
  }
  out = out.replace(re, "").replace(/\s{2,}/g, " ").trim();
  return { cleaned: out, dictPieces };
}

// âœ… ì„ íƒëœ ìˆ¨ë“¤ì„ seedsì—ì„œ ì œê±°(ì†Œë¹„)
function consumeBreathSeedsByIds(consumedIds){
  if(!Array.isArray(consumedIds) || consumedIds.length === 0) return { before: 0, after: 0 };

  const set = new Set(consumedIds.filter(Boolean));
  const arr = safeJsonParse(localStorage.getItem(BREATH_SEEDS_KEY), []);

  if(!Array.isArray(arr)) return { before: 0, after: 0 };

  const before = arr.length;
  const next = arr.filter(it => !set.has(it?.id));
  localStorage.setItem(BREATH_SEEDS_KEY, JSON.stringify(next));

  return { before, after: next.length };
}

  function writeJson(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }
  function nowId(prefix){
    return `${prefix}-${Date.now()}-${Math.floor(Math.random()*100000)}`;
  }
 function setStatus(msg){
  const el = document.getElementById("status");
  if(el) el.textContent = msg;
  console.log("[breath-language]", msg);
}


  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  // ===== 1) thinking inbox ì—ì„œ ìˆ¨ í›„ë³´ ë§Œë“¤ê¸° =====
  // inbox í•­ëª© í˜•íƒœ: { id, room, text, from, createdAt }
  // ì—¬ê¸°ì„œëŠ” â€œìˆ¨ê²° í›„ë³´ breathâ€ í˜•íƒœë¡œ ë³€í™˜:
  // { breathText, fromRoom, createdAt, meaning, emotionDirection }
function loadBreathSeeds(){
  // âœ… Gate: ë¸Œë¦¿ì§€ë¥¼ í†µê³¼í•œ bundleë§Œ ìˆ¨ê²°ë°©ì— ì…ì¥ ê°€ëŠ¥
  const bundle = safeJsonParse(localStorage.getItem("breath-bundle"), []);
  if (!Array.isArray(bundle) || bundle.length === 0) {
    setStatus("ë¸Œë¦¿ì§€ ë¬¶ìŒì´ ì—†ì–´ Â· ê³µëª… ë¸Œë¦¿ì§€ë¡œ ì´ë™");
    // ìˆ¨ê²°ë°©ì€ 'ì„ íƒëœ ìˆ¨'ë§Œ ë‹¤ë£¨ëŠ” í¸ì§‘ì‹¤ì´ë¯€ë¡œ, ì…ì¥ê¶Œì´ ì—†ìœ¼ë©´ ë˜ëŒë¦°ë‹¤
    setTimeout(() => { window.location.href = "/resonance-bridge.html"; }, 400);
    return [];
  }

  // bundle -> seeds í˜•íƒœë¡œ ë³€í™˜ (breathText/fromRoom)
  return bundle.map(it => ({
    id: it.id || nowId("b"),
    text: (it.breathText || it.text || "").toString(),
    source: it.fromRoom || it.source || "unknown",
    createdAt: it.createdAt || new Date().toISOString(),
  }));
}


  function inferMeaning(text){
    const t = (text||"");
    if(t.includes("ë¶ˆì•ˆ")) return "ë¶ˆì•ˆ";
    if(t.includes("ì‚¬ë‘")) return "ì‚¬ë‘";
    if(t.includes("ê´€ê³„")) return "ê´€ê³„";
    if(t.includes("ì„ íƒ")) return "ì„ íƒ";
    return "ì¤‘ë¦½";
  }
  function inferDirection(text){
    const t = (text||"");
    // ì•„ì£¼ ë‹¨ìˆœ: ì˜ë¬¸/ê²½ê³„/í™•ì¸ ê°™ì€ ë‹¨ì–´ê°€ ìˆìœ¼ë©´ "ì—´ë¦¼", ë‹¨ì •/ì‹¬íŒì´ ê°•í•˜ë©´ "ë‹«í˜" (ëŒ€ì¶©)
    if(t.includes("?") || t.includes("ì–´ë–¨ê¹Œ") || t.includes("í™•ì¸")) return "ì—´ë¦¼";
    if(t.includes("ì¡°ì‘") || t.includes("íŒ”ì•„") || t.includes("ì•ˆ ë¼")) return "ê²½ê³„";
    return "ì¤‘ë¦½";
  }

  function makeCandidatesFromInbox(inbox){
    // ìµœì‹ ì´ ë’¤ì— ìŒ“ì˜€ì„ ê°€ëŠ¥ì„±ì´ ìˆìœ¼ë‹ˆ createdAt ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬(ì—†ìœ¼ë©´ ì›ë˜ ìˆœì„œ)
    const items = inbox.slice().sort((a,b)=>{
      const ta = Date.parse(a?.createdAt||"") || 0;
      const tb = Date.parse(b?.createdAt||"") || 0;
      return ta - tb;
    });

    // ì—¬ê¸°ì„œëŠ” â€œì†”ë¹„â€ë§Œì´ ì•„ë‹ˆë¼ ì „ë¶€ í›„ë³´ë¡œ ë³´ì—¬ì£¼ë˜,
  return items.map(it => {
  const text = (it.text || "").toString().trim();
  return {
    id: it.id || nowId("b"),
    breathText: text,
    fromRoom: (it.source || "unknown").toString().toLowerCase(), // âœ… ì—¬ê¸°!
    createdAt: it.createdAt || "",
    meaning: inferMeaning(text),
    emotionDirection: inferDirection(text),
  };
});

  }


  // ===== 2) í•©ì˜ë¬¸(ì¡°í•© ê·œì¹™) =====
  // ê·œì¹™ ëª©í‘œ:
  // - summary: â€œí•œ ì¤„ í•©ì˜ë¬¸â€ (ì§§ê³  ë‹´ë‹´)
  // - body:   â€œê·¼ê±°/ë§¥ë½ + ì—´ë¦° ì§ˆë¬¸â€ í˜•íƒœë¡œ ì •ë¦¬
  function firstLine(text){
    const s = (text||"").trim();
    if(!s) return "";
    return s.split("\n").map(x=>x.trim()).filter(Boolean)[0] || "";
  }

  function clamp(s, n){
    const t = (s||"").trim();
    if(t.length <= n) return t;
    return t.slice(0,n) + "â€¦";
  }

function composeAgreement(selectedBreaths){
  // 1) ì‚¬ì „ ê´„í˜¸ ë¶„ë¦¬ + ì •ë¦¬ëœ breath ë§Œë“¤ê¸°
  const breaths = (selectedBreaths || [])
    .map(b => {
      const raw = (b?.breathText || "").toString().trim();
      const { cleaned, dictPieces } = pullDictionaryParenWithPieces(raw);
      return { ...b, breathText: cleaned, __dictPieces: dictPieces };
    })
    .filter(b => (b?.breathText || "").trim());

    breaths.sort((a,b) => (a.fromRoom === "haru") - (b.fromRoom === "haru"));
    let dictionaryNote = null;

function extractDictionary(text) {
  const match = text.match(/\(ì‚¬ì „:[^)]+\)/);
  if (match) {
    dictionaryNote = match[0];
    return text.replace(match[0], "").trim();
  }
  return text;
}

  // âœ… ë³€ê²½ (ì›ë¬¸ ì „ì²´)
const lines = breaths
  .map(b => normalizeText(extractDictionary(b.breathText)))
  .filter(Boolean);

  // 3) ì¤‘ë³µ ì œê±° (ì™„ì „ ë™ì¼í•œ ë¬¸ì¥ë§Œ ì œê±°)
  const uniqLines = Array.from(new Set(lines));

  // 4) ì‚¬ì „ì€ ë§¨ ì•„ë˜ì—ë§Œ (ìˆì„ ë•Œë§Œ)
  const dictAll = breaths.flatMap(b => Array.isArray(b.__dictPieces) ? b.__dictPieces : []);
  const dictLine = dictAll.length ? `\n\n(ì‚¬ì „: ${dictAll[0]})` : "";

  breaths.sort((a,b) => (a.fromRoom === "haru") - (b.fromRoom === "haru"));

  // 5) summaryëŠ” â€œìš”ì•½â€ì´ ì•„ë‹ˆë¼: ì¤‘ë³µ ì œê±°ëœ ì „ì²´ë¥¼ ê·¸ëŒ€ë¡œ ë³´ì—¬ì£¼ë˜,
  //    íšŒì˜ ë¦¬ìŠ¤íŠ¸ìš©ì´ë¼ ë„ˆë¬´ ê¸¸ë©´ clamp
 const summary = uniqLines.join("\n");

  // 6) bodyì—ëŠ” ì¤‘ë³µ ì œê±°ëœ ëª¨ë“  ë¬¸ì¥ì„ ë‚˜ì—´ + ì‚¬ì „(ë§¨ ì•„ë˜)
  const body =
    `${uniqLines.map(s => `- ${s}`).join("\n")}` + dictLine;

  return { summary, body };
}

  // ===== 3) meetings ì €ì¥(ë¬´ì¡°ê±´ body/summary ì±„ìš°ê¸°) =====
  function saveMeeting({ breaths, summary, body }){
    const store = safeJsonParse(localStorage.getItem(LOCAL_MEETINGS_KEY), {});
    const id = nowId("m");

    const meeting = {
      id,
      title: "ë¬´ì œ",
      topic: "ë¬´ì œ",
      summary: (summary||"").trim() || "ë¬´ì œ",
      body: (body||"").trim() || (summary||"").trim() || "ë¬´ì œ",
      breaths: Array.isArray(breaths) ? breaths : [],
      createdAt: new Date().toISOString()
    };

    // title/topic ìë™
    meeting.title = clamp(firstLine(meeting.summary) || "ë¬´ì œ", 18);
    // topicì€ meaning ìµœë¹ˆê°’ìœ¼ë¡œ
    const counts = {};
    meeting.breaths.forEach(b=>{
      const k = (b.meaning||"ë¬´ì œ").toString();
      counts[k] = (counts[k]||0) + 1;
    });
    meeting.topic = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0]?.[0] || "ë¬´ì œ";

    store[id] = meeting;
    writeJson(LOCAL_MEETINGS_KEY, store);
    localStorage.setItem(LAST_MEETING_KEY, id);

    console.log("[breath-language] saved meeting ->", meeting);
    setStatus(`íšŒì˜ ì €ì¥ ì™„ë£Œ: ${id} (summary/body ìƒì„±ë¨)`);
    return id;
  }

  // ===== UI =====
  let candidates = [];

  // âœ… í•˜ë¥´ ê¸°ì¤€ 3ê°œ ì„ íƒ (ì „ì—­ í•¨ìˆ˜: ì–´ë””ì„œë“  í˜¸ì¶œ ê°€ëŠ¥)
function pickThreeByHaru(candidates){
  const haru = candidates.filter(b => b.fromRoom === "haru");
  const others = candidates.filter(b => b.fromRoom !== "haru");

  if(haru.length === 0){
    // í•˜ë¥´ê°€ ì—†ìœ¼ë©´ ìµœì‹  3ê°œë¡œ fallback
    return candidates.slice().reverse().slice(0,3);
  }

  const anchor = haru[haru.length - 1]; // ìµœì‹  í•˜ë¥´ ì‚¬ìœ 
  const matches = others
    .filter(b => b.meaning === anchor.meaning)
    .slice(-2);

  return [anchor, ...matches];
}

function renderCandidates(list){
  const host = document.getElementById("candList");
  if(!host) return;

  if(!Array.isArray(list) || list.length === 0){
    host.innerHTML = `
      <div class="cand">
        <div class="tag">ëŒ€ê¸° Â· ì˜¤ëŠ˜ì˜ ë¬¶ìŒì´ ì—†ì–´</div>
        <div class="pre">ê³µëª… ë¸Œë¦¿ì§€ì—ì„œ ë¬¶ìŒì„ ë§Œë“  ë’¤ ì´ ë°©ìœ¼ë¡œ ë“¤ì–´ì™€.</div>
      </div>
    `;
    return;
  }

  // âœ… ìµœì‹ ì´ ìœ„ë¡œ ì˜¤ê²Œ ì •ë ¬
  const newestFirst = list.slice().sort((a,b)=>{
    const ta = Date.parse(a?.createdAt || "") || 0;
    const tb = Date.parse(b?.createdAt || "") || 0;
    return tb - ta;
  });

  host.innerHTML = newestFirst.map((b) => `
    <div class="cand">
      <div class="tag">
        ${escapeHtml((window.getSoongpoongIcon?.(b.fromRoom) || "ğŸŒ¬ï¸") + " " + (b.fromRoom || "unknown"))}
        Â· ${escapeHtml(b.meaning)} Â· ${escapeHtml(b.emotionDirection)} Â· ${escapeHtml(b.createdAt)}
      </div>
      <div class="pre">${escapeHtml(b.breathText)}</div>
    </div>
  `).join("");
}

function getSelectedBreaths(){
  // ë¸Œë¦¿ì§€ì—ì„œ ì´ë¯¸ 3ê°œ í™•ì •(bundle) â†’ ìˆ¨ê²°ë°©ì€ ê·¸ëŒ€ë¡œ í¸ì§‘ë§Œ
  return (candidates || []).slice();
}

  function pickByIds(ids){
  const map = new Map((candidates || []).map(c => [c.id, c]));
  return (ids || []).map(id => map.get(id)).filter(Boolean);
}

function loadAndRender(){
  const seeds = loadBreathSeeds();
  candidates = makeCandidatesFromInbox(seeds);

  renderCandidates(candidates);
  setStatus(`ìˆ¨ ë¡œë“œ ì™„ë£Œ: ${candidates.length}ê°œ`);

  // âœ… ìŠ¹ê²© ì¶œë ¥(í•©ì˜ë¬¸) ìë™ ì±„ìš°ê¸°: í›„ë³´ê°€ ìˆìœ¼ë©´ ë°”ë¡œ summary/body ìƒì„±
  const summaryTa = document.getElementById("summaryTa");
  const bodyTa = document.getElementById("bodyTa");

  const isEmpty = !(summaryTa?.value || "").trim() && !(bodyTa?.value || "").trim();
  if (candidates.length > 0 && isEmpty) {
    composeToTextareas();
  }
}

  function composeToTextareas(){
    const selected = getSelectedBreaths();
    const { summary, body } = composeAgreement(selected);

    document.getElementById("summaryTa").value = summary;
    document.getElementById("bodyTa").value = body;

    setStatus(`í•©ì˜ë¬¸ ìƒì„± ì™„ë£Œ (ì„ íƒ ${selected.length}ê°œ ê¸°ì¤€)`);
  }
function sendToMeeting(){
  // âœ… ìë™í™” ì¤‘ë³µ ë°©ì§€: ê°™ì€ ë¼ìš´ë“œì—ì„œ 1ë²ˆë§Œ íšŒì˜ ìƒì„±/ì´ë™
const roundId = localStorage.getItem("harulua.round.active") || "no-round";
const lockKey = `harulua.autoflow.sentMeeting.${roundId}`;
if (localStorage.getItem(lockKey)) {
  setStatus("ì´ë¯¸ íšŒì˜ë¡œ ë³´ëƒˆì–´(ì¤‘ë³µ ë°©ì§€) âœ“");
  return;
}
localStorage.setItem(lockKey, "1");

  const summaryTa = document.getElementById("summaryTa");
  const bodyTa = document.getElementById("bodyTa");

 if(!summaryTa.value.trim() || !bodyTa.value.trim()){
  composeToTextareas();
}

const selected = getSelectedBreaths();

// âœ… í•µì‹¬: summary/bodyë¥¼ ì—¬ê¸°ì„œ "ì§ì ‘" ë§Œë“¤ê±°ë‚˜ textareaì—ì„œ ê°€ì ¸ì˜¤ê¸°
const { summary, body } = composeAgreement(selected);

// ë˜ëŠ” textareaì—ì„œ ê°€ì ¸ì˜¤ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ 2ì¤„ë¡œ ë°”ê¿”ë„ ë¨
// const summary = summaryTa.value.trim();
// const body = bodyTa.value.trim();

const meetingId = saveMeeting({ breaths: selected, summary, body });

  // âœ… ì´ í„´ì˜ ì…ì¥ê¶Œ(bundle) ì†Œëª¨
  localStorage.removeItem("breath-bundle");


  // âœ… ì½˜ì†” íƒ­ êµ¬ì¡°ìš© ì•ˆì „í•€
  localStorage.setItem("harulua.lastMeetingId", meetingId);

    // âœ… ì„ íƒëœ ìˆ¨ë“¤ë§Œ ì†Œë¹„ (Bì•ˆ)
  const consumedIds = selected.map(b => b.id).filter(Boolean);
  const result = consumeBreathSeedsByIds(consumedIds);

  setStatus(
    `íšŒì˜ë¡œ ë³´ëƒ„ Â· ìˆ¨ ${consumedIds.length}ê°œ ì†Œë¹„ ` +
    `(ì”ì—¬ ${result.after}ê°œ)`
  );
// ğŸŒ¬ï¸ ì‚¬ì´í´ ì¢…ë£Œ ê·œì¹™: ìˆ¨ì´ 13ê°œ ì´ìƒ ëª¨ì˜€ë˜ ë¼ìš´ë“œëŠ” ìë™ ì •ë¦¬
const TOTAL_CYCLE = 13;
const totalBefore = result.before || candidates.length + consumedIds.length;

if (totalBefore >= TOTAL_CYCLE) {
  const flushed = flushBreathSeeds(); // ì „ì²´ ìˆ¨ ì œê±°
  console.log(`[breath-language] ğŸŒ¬ï¸ ìˆ¨ ì‚¬ì´í´ ì¢…ë£Œ Â· ${flushed}ê°œ ìˆ¨ ì •ë¦¬`);
}


  // âœ… 1) í›„ë³´ UI ì¦‰ì‹œ ë¦¬ì…‹
candidates = [];
renderCandidates(candidates);
summaryTa.value = "";
bodyTa.value = "";

// âœ… 2) 1ì´ˆ ë’¤ ìë™ìœ¼ë¡œ ìˆ¨ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°(ì”ì—¬ ìˆ¨ ë°˜ì˜)
setTimeout(() => {
  loadAndRender();
}, 1000);

// âœ… íšŒì˜ëŠ” ê°™ì€ ì°½ìœ¼ë¡œ ì´ë™(íŒì—… ì°¨ë‹¨ ë°©ì§€)
// auto=1ì´ë©´ meetingì—ì„œ ìë™ ìŠ¹ê²©ê¹Œì§€ ì´ì–´ì§
const qs = (AUTO_MODE && RETURN_TO_APP)
  ? `?id=${encodeURIComponent(meetingId)}&auto=1&return=app`
  : `?id=${encodeURIComponent(meetingId)}`;

window.location.href = `/meeting.html${qs}`;
}
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("btnLoad").addEventListener("click", loadAndRender);
    document.getElementById("btnCompose").addEventListener("click", composeToTextareas);
    document.getElementById("btnSendMeeting").addEventListener("click", sendToMeeting);

    // ìë™ 1íšŒ ë¡œë“œ
    loadAndRender();
  });
  // âœ… ìë™ ëª¨ë“œ: ìˆ¨ ë¡œë“œ â†’ í•©ì˜ë¬¸ ìƒì„± â†’ íšŒì˜ë¡œ ë³´ë‚´ê¸°
if (AUTO_MODE) {
  setTimeout(() => {
    // candidatesê°€ ìˆì–´ì•¼ íë¦„ì´ ì´ì–´ì§
    if (Array.isArray(candidates) && candidates.length > 0) {
      // summary/bodyê°€ ë¹„ì–´ìˆìœ¼ë©´ composeê°€ ì´ë¯¸ ë“¤ì–´ê°€ ìˆì§€ë§Œ í•œ ë²ˆ ë” ì•ˆì „í•€
      composeToTextareas();
      sendToMeeting();
    } else {
      setStatus("ìë™ ëª¨ë“œì§€ë§Œ í›„ë³´ ìˆ¨ì´ ì—†ì–´. ê³µëª… ë¸Œë¦¿ì§€ë¡œ ëŒì•„ê°ˆê²Œ.");
      setTimeout(() => window.location.href = "/resonance-bridge.html?auto=1", 400);
    }
  }, 350);
}

</script>
</body>
</html>
