<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>í•˜ë¥´ â€” ì‚¬ìœ ë°©</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f172a;
      --panel2:#0b1226;
      --line:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.88);
      --muted:rgba(255,255,255,.62);
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 15% 0%, #121b3a 0%, var(--bg) 45%, #070b16 100%);
      color:var(--text);
      font-family:var(--sans);
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:18px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; }
    .title{ display:flex; flex-direction:column; gap:2px; }
    .title b{ font-size:16px; letter-spacing:.2px; }
    .title span{ font-size:12px; color:var(--muted); }
    .status{
      font-family:var(--mono);
      font-size:12px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      max-width:55%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; align-items:start; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .k{ font-family:var(--mono); color:var(--muted); font-size:12px; margin:10px 0 6px; }
    textarea, input{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(0,0,0,.22);
      color:var(--text);
      padding:10px 12px;
      font-family:var(--mono);
      font-size:13px;
      outline:none;
    }
    textarea{ min-height:110px; resize:vertical; }
    .row{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .btn{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color:var(--text);
      padding:9px 11px;
      border-radius:12px;
      font-family:var(--mono);
      font-size:12px;
      cursor:pointer;
    }
    .btn:hover{ background:rgba(255,255,255,.08); }
    .btn.ok{ border-color: rgba(34,197,94,.35); }
    .btn.warn{ border-color: rgba(245,158,11,.35); }
    .btn.bad{ border-color: rgba(239,68,68,.35); }

    .mono{
      font-family:var(--mono);
      color:var(--muted);
      font-size:12px;
      white-space:pre-wrap;
      line-height:1.5;
    }

    .triGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      margin-top:10px;
    }
    .triCard{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      border-radius:14px;
      padding:12px;
      min-height:88px;
    }
    .triTitle{
      font-weight:700;
      font-size:13px;
      opacity:.9;
      margin-bottom:8px;
      font-family:var(--mono);
    }
    .triBody{
      white-space:pre-wrap;
      line-height:1.5;
      font-size:13px;
      opacity:.95;
      font-family:var(--mono);
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }
    @media (max-width: 820px){ .triGrid{ grid-template-columns: 1fr; } }
  
  .triSub{margin-top:6px;font-size:12px;opacity:.85;line-height:1.45;}
</style>
</head>

<body data-room-id="haru">
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <b>í•˜ë¥´ â€” ì‚¬ìœ ë°©</b>
        <span>ê±°ì°½í•œ ë§ë³´ë‹¤ â€˜ì˜¤ëŠ˜ ê°€ëŠ¥í•œ í•œ ì¡°ê°â€™ìœ¼ë¡œ ë‚´ë ¤ì˜¤ê¸°</span>
      </div>
      <div class="status" id="status">ready</div>
    </div>

    <!-- ğŸ” axis reference (debug minimal) -->
    <div id="axisRefMini" style="font-size:12px; opacity:0.6; margin-top:8px;"></div>

    <div class="grid">
      <div class="card">
        <div class="k">ì£¼ì œ(íšŒì˜ëŒ€ê¸°ì—ì„œ ì˜¨ ë§ / ì§ì ‘ ì…ë ¥)</div>
        <textarea id="topic" placeholder="ì—¬ê¸°ì— ì£¼ì œë¥¼ ë„£ì–´. íšŒì˜ëŒ€ê¸°ì—ì„œ â€˜ì‚¬ìœ ë°©ìœ¼ë¡œ ë³´ë‚´ê¸°â€™ë¡œ ë“¤ì–´ì˜¤ë©´ ìë™ ì£¼ì…ë¼."></textarea>

        <div class="row">
  <button class="btn ok" id="toBreathBtn">ê³µëª… ë¸Œë¦¿ì§€ë¡œ ë³´ë‚´ê¸°</button>
  <button class="btn warn" id="resetAllBtn">ì „ë¶€ ë¦¬ì…‹</button>
</div>

        <div class="k">ì‚¬ìœ  ì¡°í•© ì¹´ë“œ</div>
        <div class="triGrid" style="grid-template-columns: 1fr;">
          <div class="triCard">
            <div class="triBody" id="triCombined">{ì•„ì§ ì—†ìŒ}</div>
            <!-- âœ… ì—¬ê¸°ëŠ” "ê¸°ì–µ(Seeds) í•œ ì¤„" ì „ìš© -->
            <div class="triBody" id="todayLine">{ì•„ì§ ì—†ìŒ}</div>
          </div>
        </div>

        <div class="k">ì´ ë°©ì˜ í•œ ì¤„</div>
        <div class="triCard">
          <div class="triBody" id="roomLine">{ì•„ì§ ì—†ìŒ}</div>
          <div class="triSub" id="roomDict"></div>
        </div>

      </div>
    </div>
  </div>

  <!-- âœ… 1) ì½”ì–´ ë¨¼ì € -->
  <script src="/thinking/thinking-core.js?v=20251231-3"></script>

  <!-- âœ… 2) ë°© ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    // ====== Keys ======
    const RID = (document.body?.dataset?.roomId || document.body?.dataset?.room || "haru").trim().toLowerCase();
    const BREATH_SEEDS_KEY = "harulua.breath.seeds";
    const AUTO_SEND = false;

    // ====== Elements ======
    const statusEl = document.getElementById("status");
    const topicEl  = document.getElementById("topic");

    function setStatus(msg){ statusEl.textContent = msg || "ready"; }

    function extractKeywords(t){
      return (t || "")
        .replace(/[^\p{L}\p{N}\s]/gu, " ")
        .split(/\s+/)
        .filter(x => x.length >= 2)
        .slice(0, 6);
    }

    function getInhaleKeyword(){
  try {
    const b = JSON.parse(localStorage.getItem("harulua.cross.inhale.bundle") || "null");
    const k = (b?.keyword || "").toString().trim();
    return k || "ì£¼ì œ";
  } catch (e) {
    return "ì£¼ì œ";
  }
}

    function resetAllRoom(){
  // 1) í™”ë©´ ì „ë¶€ ë¹„ìš°ê¸°
  if (topicEl) topicEl.value = "";
  const idsToClearText = ["triCombined", "todayLine", "roomLine", "roomDict"];
  idsToClearText.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = "{ì•„ì§ ì—†ìŒ}";
  });

  // 2) ìƒíƒœ í‘œì‹œ
  setStatus("ready");

  // 3) ì´ ë°©ì— í•´ë‹¹í•˜ëŠ” ë¡œì»¬ ì €ì¥(ìƒíƒœ/ì˜¤ëŠ˜ refpack)ë„ ì‚­ì œ
  // thinking-core ê¸°ì¤€ í‚¤
  try {
    localStorage.removeItem(`harulua.thinking.${RID}.state`);
    localStorage.removeItem(`harulua.refpack.${RID}`);
  } catch {}
}

    // ====== UI: axis render (ì½”ì–´ê°€ onAxisLoadedë¡œ ë„˜ê¹€) ======
    function renderAxisUI(axis){
      // âœ… ì¹´ë“œ UIê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì•„ë¬´ ê²ƒë„ í•˜ì§€ ì•ŠìŒ
      const conceptEl = document.getElementById("axisConcept");
      if (!conceptEl) return;

      const descEl = document.getElementById("axisDesc");
      const pEl = document.getElementById("axisPrinciple");
      const refMiniEl = document.getElementById("axisRefMini");
      if(!axis) return;

      conceptEl.textContent = `ğŸŒŒ ${axis.concept || "â€”"}`;
      descEl.textContent = Array.isArray(axis.description)
        ? axis.description.join("\n")
        : (axis.description || "â€”");

      if(axis.principle && typeof axis.principle === "object"){
        const lines = [];
        Object.keys(axis.principle).forEach(k => lines.push(`${k}: ${axis.principle[k]}`));
        pEl.textContent = lines.join("\n");
      } else {
        pEl.textContent = axis.principle || "";
      }

      if(refMiniEl) refMiniEl.textContent = `ğŸ“¦ axis: /data/axis/${RID}.json`;
    }

    // ====== Seed(ê¸°ì–µ í•œ ì¤„) ë¡œë“œ ======
    function loadSeedLineFromStorage(roomId){
      try{
        const raw = localStorage.getItem(BREATH_SEEDS_KEY);
        if(!raw) return "";
        const data = JSON.parse(raw);

        // âœ… ë‹¤ì–‘í•œ í˜•íƒœë¥¼ í—ˆìš© (ë°°ì—´/ë¬¸ìì—´/ê°ì²´)
        const v = data?.[roomId] ?? data?.[String(roomId || "").toLowerCase()];
        if(!v) return "";

        if(Array.isArray(v)){
          // { line: "..."} ë˜ëŠ” "..." ë‘˜ ë‹¤ ì²˜ë¦¬
          const last = v[v.length - 1];
          if(typeof last === "string") return last.trim();
          if(last && typeof last === "object") return String(last.line || last.text || "").trim();
          return "";
        }
        if(typeof v === "string") return v.trim();
        if(v && typeof v === "object") return String(v.line || v.text || "").trim();
        return "";
      }catch(e){
        return "";
      }
    }

    function renderSeedLine(){
      const el = document.getElementById("todayLine");
      if(!el) return;

      let seed = loadSeedLineFromStorage(RID);
      if(!seed) seed = "{ì•„ì§ ì—†ìŒ}";
      el.textContent = seed;
    }

    // ====== í•˜ë¥´ 3íšŒ ì‚¬ìœ  ======
    function haruTri(topicText){
      // per-room unique 3-thought from /data/axis/<room>.json
      return axisTri(document.body.dataset.roomId || "haru", topicText);
    }

    function haruThinkThree(){
      const topic = topicEl.value.trim();
      if(!topic){ setStatus("empty topic"); return; }

      const tri = haruTri(topic);
      const combined = `${tri.def}\n\n${tri.bound}\n\n${tri.act}`.trim();
      document.getElementById("triCombined").textContent = combined;

      // âœ… ì˜¤ëŠ˜ë¼ì¸ì€ "ê¸°ì–µ(seeds)" ì „ìš©ìœ¼ë¡œ ìœ ì§€
      renderSeedLine();

      // âœ… ì´ ë°©ì˜ í•œ ì¤„ë„ ê°™ì´ ê°±ì‹ 
      renderRoomLine();

      setStatus("think 3x: ok");

      if(AUTO_SEND) sendToBreathLanguage();
    }

    // ====== ë¬¸ì¥ ë ì •ë¦¬ ìœ í‹¸(í•˜ë¥´ ë°© ë‚´ë¶€ì—ì„œë§Œ ì”€) ======
    function stripEndPunc(s){
      return String(s || "").trim().replace(/[.ã€‚!?â€¦]+$/g, "").trim();
    }
    function ensurePeriod(s){
      const t = String(s || "").trim();
      if(!t) return "";
      if(/[.ã€‚!?]$/.test(t)) return t;
      return t + ".";
    }

    // ====== ìˆ¨ê²°ë¡œ ë³´ë‚´ê¸°: ìŠ¹ê²©+ì‚¬ì „+seed â†’ í•œ ë¬¸ì¥(ì••ì¶•ë§Œ, ê¸°ì–µ ì‹œì‘) ======
    function haruBuildBreathTextNow(){
      const rawTopic = (topicEl?.value || "").trim();
      if(!rawTopic) return "";

      // âœ… firstSentë¥¼ ë¨¼ì € ì„ ì–¸(ë²„ê·¸ ë°©ì§€)
      const firstSent = (s) => {
        const t = (s || "").replace(/\s+/g, " ").trim();
        if (!t) return "";
        const cut = t.split(/[.!?ã€‚]\s*/)[0].trim();
        return cut || t;
      };

      const chunks = rawTopic
        .split(/\n\s*\n/g)
        .map(s => (s || "").trim())
        .filter(Boolean);

      const promoted = (chunks[0] || "").replace(/\s+/g, " ").trim();
      const dictLine = (chunks[1] || "").replace(/\s+/g, " ").trim();

      // âœ… seedëŠ” todayLine(= ê¸°ì–µ í•œ ì¤„)ì—ì„œ ê°€ì ¸ì˜¨ë‹¤
      let seedLine = (document.getElementById("todayLine")?.textContent || "").trim();
      if (seedLine.startsWith("{ì•„ì§")) seedLine = "";

      // seedê°€ ë¹„ì–´ìˆìœ¼ë©´ ìµœì†Œ fallback
      if (!seedLine) seedLine = firstSent(dictLine) || firstSent(promoted) || "";

      const s1 = firstSent(seedLine);
      const p1 = firstSent(promoted);
      const d1 = firstSent(dictLine);

           let sentence = "";

      // âœ… ë©”ì¸: ê¸°ì–µ + ìŠ¹ê²©
      if (s1 && p1) {
        sentence = `${stripEndPunc(s1)}, ${stripEndPunc(p1)}`;
      } else {
        sentence = s1 || p1 || rawTopic;
      }

      // âœ… ì‚¬ì „ í•œ ì¤„ì€ ê´„í˜¸ë¡œ ë³´ì¡°
     if (d1) {
  const clean = stripEndPunc(d1);
  const label = getInhaleKeyword();   // âœ… êµ­ì–´ì‚¬ì „ ê²€ìƒ‰ì–´ê°€ ë¼ë²¨
  sentence += ` (${label}: ${clean})`;
}


      return ensurePeriod(sentence);
    }

    function haruBuildOneLine(){
      return haruBuildBreathTextNow();
    }

    function renderRoomLine(){
      const line = (haruBuildBreathTextNow() || "").trim();
      const el = document.getElementById("roomLine");
      if(el) el.textContent = line || "{ì•„ì§ ì—†ìŒ}";
    }

    // topic ì…ë ¥ ì‹œì—ë„ â€œì´ ë°©ì˜ í•œ ì¤„â€ì€ ì¦‰ì‹œ ê°±ì‹ 
    topicEl?.addEventListener("input", () => {
      renderSeedLine();
      renderRoomLine();
    });

    window.addEventListener("pageshow", () => {
      renderSeedLine();
      renderRoomLine();
    });

   function haruResetForNext(){
  resetAllRoom(); // âœ… ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ìœ„í•´ ì „ë¶€ ë¹„ì›€
}

    // âœ… ì‚¬ìœ ë°© -> ê³µëª… ë¸Œë¦¿ì§€ë¡œ ë³´ë‚´ê¸° (ê¸°ì¡´ ìˆ¨ê²°ë°© ì§í–‰ ë¡œì§ ì°¨ë‹¨)
(function wireToResonanceBridge(){
  const btn = document.getElementById("toBreathBtn");
  if(!btn) return;

  const BREATH_SEEDS_KEY = "harulua.breath.seeds";

  function safeJsonParse(v, fallback){
    if (v == null) return fallback;
    try { return JSON.parse(v); } catch { return fallback; }
  }
  function nowId(prefix){
    return `${prefix}-${Date.now()}-${Math.floor(Math.random()*100000)}`;
  }

  // âš ï¸ capture=true ë¡œ ë¨¼ì € ê°€ë¡œì±„ê³ , stopImmediatePropagation ìœ¼ë¡œ ê¸°ì¡´ í•¸ë“¤ëŸ¬ë¥¼ ë§‰ì•„ë²„ë¦¼
  btn.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopImmediatePropagation();

    const breathText = (haruBuildBreathTextNow?.() || "").trim();
    if(!breathText){
      alert("ì£¼ì œ(í…ìŠ¤íŠ¸)ê°€ ë¹„ì–´ìˆì–´. ë¨¼ì € í•œ ì¤„ì„ ë§Œë“¤ì–´ì¤˜ ğŸ™‚");
      return;
    }

    const arr = safeJsonParse(localStorage.getItem(BREATH_SEEDS_KEY), []);
    const next = Array.isArray(arr) ? arr : [];

    // âœ… ì´ ë°©ì—ì„œ ë§Œë“  ìˆ¨ 1ê°œë§Œ seedsì— ì¶”ê°€
    next.push({
      id: nowId("b"),
      text: breathText,
      source: "haru",                 // â† ë°© ì´ë¦„(íŒŒì¼ë§ˆë‹¤ ë°”ê¿”ì£¼ë©´ ë¨)
      createdAt: new Date().toISOString()
    });

    localStorage.setItem(BREATH_SEEDS_KEY, JSON.stringify(next));

    // âœ… ì´ì œ ìˆ¨ê²°ë°©ì´ ì•„ë‹ˆë¼ "ê³µëª… ë¸Œë¦¿ì§€"ë¡œ ì´ë™
    window.location.href = "/resonance-bridge.html";
  }, true);
})();

    // ====== í›… ë“±ë¡ (ì¤‘ìš”: ë“±ë¡ë§Œ!) ======
    registerThinkingRoom(RID, {
      thinkThree: haruThinkThree,
      buildBreathTextNow: haruBuildBreathTextNow,
      buildOneLine: haruBuildOneLine,
      resetForNext: haruResetForNext,
      onAxisLoaded: renderAxisUI
    });

    
    // ====== ì´ë²¤íŠ¸ ì—°ê²° ======
    document.getElementById("resetAllBtn")?.addEventListener("click", resetAllRoom);
    // ====== ì‹œì‘ ======
    // ì²˜ìŒ ë“¤ì–´ì™”ì„ ë•Œë„ seed/í•œì¤„ì´ ë³´ì´ë„ë¡
    renderSeedLine();
    renderRoomLine();
  </script>
</body>
</html>
