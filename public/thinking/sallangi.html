<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì‚´ë‘ì´ â€” ì‚¬ìœ ë°©</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f172a;
      --panel2:#0b1226;
      --line:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.88);
      --muted:rgba(255,255,255,.62);
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 15% 0%, #121b3a 0%, var(--bg) 45%, #070b16 100%);
      color:var(--text);
      font-family:var(--sans);
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:18px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; }
    .title{ display:flex; flex-direction:column; gap:2px; }
    .title b{ font-size:16px; letter-spacing:.2px; }
    .title span{ font-size:12px; color:var(--muted); }
    .status{
      font-family:var(--mono);
      font-size:12px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      max-width:55%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; align-items:start; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .k{ font-family:var(--mono); color:var(--muted); font-size:12px; margin:10px 0 6px; }
    textarea, input{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(0,0,0,.22);
      color:var(--text);
      padding:10px 12px;
      font-family:var(--mono);
      font-size:13px;
      outline:none;
    }
    textarea{ min-height:110px; resize:vertical; }
    .row{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .btn{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color:var(--text);
      padding:9px 11px;
      border-radius:12px;
      font-family:var(--mono);
      font-size:12px;
      cursor:pointer;
    }
    .btn:hover{ background:rgba(255,255,255,.08); }
    .btn.ok{ border-color: rgba(34,197,94,.35); }
    .btn.warn{ border-color: rgba(245,158,11,.35); }
    .btn.bad{ border-color: rgba(239,68,68,.35); }

    .mono{
      font-family:var(--mono);
      color:var(--muted);
      font-size:12px;
      white-space:pre-wrap;
      line-height:1.5;
    }

    .triGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      margin-top:10px;
    }
    .triCard{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      border-radius:14px;
      padding:12px;
      min-height:88px;
    }
    .triTitle{
      font-weight:700;
      font-size:13px;
      opacity:.9;
      margin-bottom:8px;
      font-family:var(--mono);
    }
    .triBody{
      white-space:pre-wrap;
      line-height:1.5;
      font-size:13px;
      opacity:.95;
      font-family:var(--mono);
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }
    @media (max-width: 820px){ .triGrid{ grid-template-columns: 1fr; } }
  
  .triSub{margin-top:6px;font-size:12px;opacity:.85;line-height:1.45;}
</style>
</head>

<body data-room-id="sallangi">
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <b>ì‚´ë‘ì´ â€” ì‚¬ìœ ë°©</b>
        <span>ê±°ì°½í•œ ë§ë³´ë‹¤ â€˜ì˜¤ëŠ˜ ê°€ëŠ¥í•œ í•œ ì¡°ê°â€™ìœ¼ë¡œ ë‚´ë ¤ì˜¤ê¸°</span>
      </div>
      <div class="status" id="status">ready</div>
    </div>
<!-- ğŸ” axis reference (debug minimal) -->
<div id="axisRefMini"
     style="font-size:12px; opacity:0.6; margin-top:8px;">
</div>

    <div class="grid">
      <div class="card">
        <div class="k">ì£¼ì œ(íšŒì˜ëŒ€ê¸°ì—ì„œ ì˜¨ ë§ / ì§ì ‘ ì…ë ¥)</div>
        <textarea id="topic" placeholder="ì—¬ê¸°ì— ì£¼ì œë¥¼ ë„£ì–´. íšŒì˜ëŒ€ê¸°ì—ì„œ â€˜ì‚¬ìœ ë°©ìœ¼ë¡œ ë³´ë‚´ê¸°â€™ë¡œ ë“¤ì–´ì˜¤ë©´ ìë™ ì£¼ì…ë¼."></textarea>
        
       <div class="row">
  <button class="btn ok" id="toBreathBtn">ê³µëª… ë¸Œë¦¿ì§€ë¡œ ë³´ë‚´ê¸°</button>
  <button class="btn warn" id="resetAllBtn">ì „ë¶€ ë¦¬ì…‹</button>
</div>

        <div class="k">ì‚¬ìœ  ì¡°í•© ì¹´ë“œ</div>
        <div class="triGrid" style="grid-template-columns: 1fr;">
          <div class="triCard">
            <div class="triBody" id="triCombined">{ì•„ì§ ì—†ìŒ}</div>
            <div class="triBody" id="todayLine">{ì•„ì§ ì—†ìŒ}</div>
          </div>
        </div>
<div class="k">ì´ ë°©ì˜ í•œ ì¤„</div>
<div class="triCard">
  <div class="triBody" id="roomLine">{ì•„ì§ ì—†ìŒ}</div>
          <div class="triSub" id="roomDict"></div>
</div>

      </div>
    </div>
  </div>

  <!-- âœ… 1) ì½”ì–´ ë¨¼ì € -->
  <script src="/thinking/thinking-core.js?v=20251231-3"></script>

  <!-- âœ… 2) ë°© ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    // ====== Keys ======
    const RID = (document.body?.dataset?.roomId || document.body?.dataset?.room || "sallangi").trim().toLowerCase();

  
    const BREATH_SEEDS_KEY = "harulua.breath.seeds";
    const AUTO_SEND = false;

    // ====== Elements ======
    const statusEl = document.getElementById("status");
    const topicEl = document.getElementById("topic");
    

    function setStatus(msg){ statusEl.textContent = msg || "ready"; }
    function pick(arr, key){
      let h = 0;
      const s = String(key || "");
      for (let i=0;i<s.length;i++) h = (h*31 + s.charCodeAt(i)) >>> 0;
      return arr[h % arr.length];
    }
    function extractKeywords(t){
      return (t || "")
        .replace(/[^\p{L}\p{N}\s]/gu, " ")
        .split(/\s+/)
        .filter(x => x.length >= 2)
        .slice(0, 6);
    }

    function resetAllRoom(){
  // 1) í™”ë©´ ì „ë¶€ ë¹„ìš°ê¸°
  if (topicEl) topicEl.value = "";
  const idsToClearText = ["triCombined", "todayLine", "roomLine", "roomDict"];
  idsToClearText.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = "{ì•„ì§ ì—†ìŒ}";
  });

  // 2) ìƒíƒœ í‘œì‹œ
  setStatus("ready");

  // 3) ì´ ë°©ì— í•´ë‹¹í•˜ëŠ” ë¡œì»¬ ì €ì¥(ìƒíƒœ/ì˜¤ëŠ˜ refpack)ë„ ì‚­ì œ
  // thinking-core ê¸°ì¤€ í‚¤
  try {
    localStorage.removeItem(`harulua.thinking.${RID}.state`);
    localStorage.removeItem(`harulua.refpack.${RID}`);
  } catch {}
}

    // ====== UI: axis render (ì½”ì–´ê°€ onAxisLoadedë¡œ ë„˜ê¹€) ======
   function renderAxisUI(axis){
  // âœ… ì¹´ë“œ UIê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì•„ë¬´ ê²ƒë„ í•˜ì§€ ì•ŠìŒ
  const conceptEl = document.getElementById("axisConcept");
  if (!conceptEl) return;

  const descEl = document.getElementById("axisDesc");
  const pEl = document.getElementById("axisPrinciple");
  const refMiniEl = document.getElementById("axisRefMini");
  if(!axis) return;

  conceptEl.textContent = `ğŸŒŒ ${axis.concept || "â€”"}`;
  descEl.textContent = Array.isArray(axis.description)
    ? axis.description.join("\n")
    : (axis.description || "â€”");

  if(axis.principle && typeof axis.principle === "object"){
    const lines = [];
    Object.keys(axis.principle).forEach(k => lines.push(`${k}: ${axis.principle[k]}`));
    pEl.textContent = lines.join("\n");
  } else {
    pEl.textContent = axis.principle || "";
  }

  refMiniEl.textContent = `ğŸ“¦ axis: /data/axis/sallangi.json`;
}


    // ====== í•˜ë¥´ 3íšŒ ì‚¬ìœ  ======
    function haruTri(topicText){
  // per-room unique 3-thought from /data/axis/<room>.json
  return axisTri(document.body.dataset.roomId || "sallangi", topicText);
}

    function makeTodayLine(topicText){
      const t = (topicText || "").trim();
      const keys = extractKeywords(t);
      const k = keys[0] || "ì´ ë§ˆìŒ";
      const pool = [
        `ì˜¤ëŠ˜ì€ "${k}"ë¥¼ í•´ê²°í•˜ê¸°ë³´ë‹¤, í•œ ì¡°ê°ë§Œ ì›€ì§ì—¬ë„ ì¶©ë¶„í•´.`,
        `"${k}"ê°€ ì»¤ ë³´ì—¬ë„, ì˜¤ëŠ˜ì€ ì‘ì€ ì²´í¬ í•˜ë‚˜ë©´ ë¼.`,
        `ì§€ê¸ˆì€ ê²°ë¡  ëŒ€ì‹  â€˜ê°€ëŠ¥í•œ í•œ ê±¸ìŒâ€™ì´ ë” ì¤‘ìš”í•´.`
      ];
      return pick(pool, t + "|" + k);
    }

    function haruThinkThree(){
      const topic = topicEl.value.trim();
      if(!topic){ setStatus("empty topic"); return; }

      const tri = haruTri(topic);
      const combined = `${tri.def}\n\n${tri.bound}\n\n${tri.act}`.trim();
      document.getElementById("triCombined").textContent = combined;

      const today = makeTodayLine(topic);
      document.getElementById("todayLine").textContent = today;

   
      setStatus("think 3x: ok");
        

      if(AUTO_SEND) sendToBreathLanguage();
    }
function pickTwoSentences(text){
  const t = String(text || "")
    .replace(/\s+/g, " ")
    .trim();
  if(!t) return "";

  const parts = t
    .split(/(?<=[.!?ã€‚]|ë‹¤\.|ì§€\.|ìš”\.|ì•¼\.)\s+|\n+/g)
    .map(s => s.trim())
    .filter(Boolean);

  return parts.slice(0, 2).join(" ");
}

function sallangiBuildBreathTextNow(){
  const topic = (topicEl?.value || "").trim();
  if(!topic){
    const dictEl = document.getElementById("roomDict");
    if(dictEl) dictEl.textContent = "";
    return "";
  }

  // 1ï¸âƒ£ ì‚¬ìœ  ìš°ì„ : triCombined
  const tri = (document.getElementById("triCombined")?.textContent || "").trim();
  let out = pickTwoSentences(tri);

  // 2ï¸âƒ£ ì—†ìœ¼ë©´ todayLine
  if(!out){
    const today = (document.getElementById("todayLine")?.textContent || "").trim();
    out = pickTwoSentences(today);
  }

  // 3ï¸âƒ£ ì‚¬ì „/ìŠ¹ê²© ì™„ì „ ì°¨ë‹¨
  const dictEl = document.getElementById("roomDict");
  if(dictEl) dictEl.textContent = "";

  return out;
}

function renderRoomLine(){
  const line = (sallangiBuildBreathTextNow() || "").trim();
  const el = document.getElementById("roomLine");
  if(el) el.textContent = line || "{ì•„ì§ ì—†ìŒ}";
}
topicEl?.addEventListener("input", renderRoomLine);
window.addEventListener("pageshow", renderRoomLine);

// ë¬¸ì¥ ë ì •ë¦¬ ìœ í‹¸(í•˜ë¥´ ë°© ë‚´ë¶€ì—ì„œë§Œ ì”€)
function stripEndPunc(s){
  return String(s || "").trim().replace(/[.ã€‚!?â€¦]+$/g, "").trim();
}
function ensurePeriod(s){
  const t = String(s || "").trim();
  if(!t) return "";
  // í•œêµ­ì–´ ë¬¸ì¥ ë§ˆì¹¨í‘œ/ëŠë‚Œí‘œ/ë¬¼ìŒí‘œê°€ ì´ë¯¸ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ
  if(/[.ã€‚!?]$/.test(t)) return t;
  return t + ".";
}

function haruResetForNext(){
  resetAllRoom(); // âœ… ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ìœ„í•´ ì „ë¶€ ë¹„ì›€
}

    // ====== í›… ë“±ë¡ (ì¤‘ìš”: ë“±ë¡ë§Œ!) ======
    registerThinkingRoom(RID, {
  thinkThree: haruThinkThree,
  buildBreathTextNow: sallangiBuildBreathTextNow,
  
  resetForNext: haruResetForNext,
  onAxisLoaded: renderAxisUI
});


    
    // ====== ì´ë²¤íŠ¸ ì—°ê²° ======
    document.getElementById("resetAllBtn")?.addEventListener("click", resetAllRoom);
    

    // ë’¤ë¡œê°€ê¸°ë¡œ ëŒì•„ì™€ë„ ë¦¬ì…‹ì´ í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ
    window.addEventListener("pageshow", (e) => {
      if(e.persisted){
        // ì›í•˜ëŠ” ê²½ìš°ë§Œ(ìë™ ë¦¬ì…‹ì´ ì‹«ìœ¼ë©´ ì£¼ì„ ì²˜ë¦¬)
        // haruResetForNext();
      }
    });

    // ====== ì‹œì‘ ======
    // ì½”ì–´ê°€ topic ì£¼ì…/ë²„íŠ¼ ë°”ì¸ë”©ì„ í•œë‹¤ë©´ ì—¬ê¸°ì„œëŠ” ìµœì†Œë§Œ
    // (ì½”ì–´ save/loadë¥¼ ì“°ëŠ” ê²½ìš°ê°€ ë§ì•„ì„œ) ë¡œì»¬ ë¡œë“œë§Œ í•´ë‘ 
      
  </script>
</body>
</html>
