<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì •í™”í†µ - ìˆ¨</title>
  <style>
body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0f1115;
      color: #e6e8ee;
      margin: 0;
      padding: 32px;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 8px;
    }

    p.sub {
      color: #9aa0b3;
      margin-bottom: 24px;
      font-size: 14px;
    }

    textarea {
      width: 100%;
      min-height: 140px;
      background: #171a21;
      color: #e6e8ee;
      border: 1px solid #2a2f3a;
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      resize: vertical;
    }

    .panel {
      margin-top: 16px;
      padding: 12px;
      background: #151821;
      border-radius: 8px;
      border: 1px solid #232837;
    }

    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
    }

    .score {
      font-size: 16px;
    }

    .score span {
      font-weight: bold;
    }

    button {
      background: #2b6cff;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
    }

    button:disabled {
      background: #3a3f4b;
      cursor: not-allowed;
    }

    .log {
      margin-top: 16px;
      font-size: 13px;
      color: #9aa0b3;
      white-space: pre-wrap;
    }

    /* purify-bin ì „ìš© */
    .topbar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .back {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      color: #cfd3df;
      text-decoration: none;
      font-weight: 600;
    }
    .back:hover { opacity: 0.9; }
    .metaRow {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      color: #9aa0b3;
      margin-top: 6px;
      font-size: 13px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #2b3140;
      background: rgba(255,255,255,0.03);
    }
    .danger {
      border-color: rgba(255, 90, 90, 0.35);
      background: rgba(255, 90, 90, 0.08);
      color: #ffb3b3;
    }
    .ghost {
      background: transparent;
      border: 1px solid #2b3140;
      color: #cfd3df;
    }
    .ghost:hover {
      border-color: #3a4256;
      background: rgba(255,255,255,0.03);
    }
    .btnDanger {
      border: 1px solid rgba(255, 90, 90, 0.35);
      background: rgba(255, 90, 90, 0.12);
      color: #ffd1d1;
    }
    .btnDanger:hover { background: rgba(255, 90, 90, 0.18); }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 14px 0 18px;
    }
    input[type="search"] {
      width: 320px;
      max-width: 100%;
      background: rgba(255,255,255,0.03);
      border: 1px solid #2b3140;
      color: #e8eaf0;
      padding: 10px 12px;
      border-radius: 10px;
      outline: none;
    }
    input[type="search"]:focus {
      border-color: #3a4256;
      box-shadow: 0 0 0 2px rgba(64, 94, 255, 0.15);
    }

    /* ê°„ë‹¨ ëª¨ë‹¬ */
    .modalBg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }
    .modal {
      width: 560px;
      max-width: 100%;
      border-radius: 16px;
      border: 1px solid #2b3140;
      background: #121522;
      box-shadow: 0 18px 60px rgba(0,0,0,0.55);
      padding: 16px;
    }
    .modal h3 { margin: 0 0 8px; font-size: 18px; }
    .modal p { margin: 0 0 12px; color: #cfd3df; line-height: 1.5; }
    .modal .actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
      margin-top: 14px;
    }
    .muted { color: #9aa0b3; font-size: 13px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <a class="back" href="/console.html">â† ë©”ì¸ìœ¼ë¡œ</a>
      <span class="badge danger">ì •í™”í†µ</span>
      <span class="badge">ìˆ¨ì—ì„œ ì ê¹ ë‚´ë ¤ë†“ì€ ì–¸ì–´ë“¤</span>
    </div>

    <h1>ì •í™”í†µ</h1>
    <p class="subtitle">ì—¬ê¸°ëŠ” â€œì‚­ì œ ì „ ëŒ€ê¸° êµ¬ì—­â€ì´ì•¼. ë‹¤ì‹œ ìˆ¨ìœ¼ë¡œ ëŒë¦¬ê±°ë‚˜, íšŒì˜ë¡œ ë³´ë‚´ê±°ë‚˜, ì˜êµ¬ ì‚­ì œ(í•˜ë“œ ì‚­ì œ)í•  ìˆ˜ ìˆì–´.</p>

    <div class="metaRow">
      <span class="badge">ì´ <b id="count">0</b>ê°œ</span>
      <span class="badge">ìµœê·¼ ê°±ì‹ : <b id="updatedAt">-</b></span>
      <span class="badge">ì •í™” ê¸°ì¤€: <b>í•˜ë¥´ë£¨ì•„ì™€ ë¬´ê´€ / ì¤‘ë³µ / ì¡ìŒ</b></span>
    </div>

    <div class="toolbar">
      <input id="search" type="search" placeholder="ê²€ìƒ‰: ë¬¸ì¥/íƒœê·¸/ì¶œì²˜ë¡œ ì°¾ê¸°â€¦" />
      <button class="ghost" id="reloadBtn">ìƒˆë¡œê³ ì¹¨</button>
      <button class="ghost" id="emptyBtn" title="ì •í™”í†µì„ ë¹„ìš°ëŠ” ê±´ ë˜ëŒë¦´ ìˆ˜ ì—†ì–´">ì „ì²´ ì˜êµ¬ ì‚­ì œ</button>
    </div>

    <div id="list"></div>

    <div id="empty" class="card" style="display:none;">
      <div class="subtitle" style="margin:0;">ì •í™”í†µì´ ë¹„ì–´ ìˆì–´. ìˆ¨ì´ ê¹¨ë—í•˜ë„¤ ğŸ™‚</div>
      <div class="muted" style="margin-top:10px;">
        íŒ: â€œíšŒì˜ ëŒ€ê¸°â€ ì¹´ë“œì—ì„œ <b>ì ê¹ ë‘ê¸°</b>ë¥¼ ëˆ„ë¥´ë©´ ì—¬ê¸°ë¡œ ë“¤ì–´ì˜¤ê²Œ ë§Œë“¤ë©´ íë¦„ì´ ìì—°ìŠ¤ëŸ¬ì›Œ.
      </div>
    </div>

    <div class="footer muted" style="margin-top:22px;">
      * â€œì˜êµ¬ ì‚­ì œâ€ëŠ” íŒŒì¼ì—ì„œ ì™„ì „íˆ ì œê±°ë˜ëŠ” ë‹¨ê³„ì•¼. (ë˜ëŒë¦¬ê¸° ì—†ìŒ)
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modalBg" id="modalBg" role="dialog" aria-modal="true">
    <div class="modal">
      <h3 id="modalTitle">í™•ì¸</h3>
      <p id="modalDesc">ì •ë§ ì§„í–‰í• ê¹Œ?</p>
      <div class="muted" id="modalHint"></div>
      <div class="actions">
        <button class="ghost" id="cancelBtn">ì·¨ì†Œ</button>
        <button class="btnDanger" id="confirmBtn">ì§„í–‰</button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // ë°ì´í„° ì†ŒìŠ¤(ê³¨ê²©)
    // 1) ìš°ì„ ì€ ì •ì  JSON íŒŒì¼ë¡œ ì½ê¸°: /data/purify-bin.json
    // 2) ì„œë²„ ë¶™ì´ë©´ APIë¡œ êµì²´:
    //    GET  /api/purify-bin
    //    POST /api/purify-bin/restore
    //    POST /api/purify-bin/send-to-meeting
    //    DELETE /api/purify-bin/:id
    // =========================

    const DATA_URL = "/data/purify-bin.json"; // ë‚˜ì¤‘ì— /api/purify-bin ë¡œ ë°”ê¿”ë„ ë¨

    const $ = (id) => document.getElementById(id);
    const listEl = $("list");
    const emptyEl = $("empty");
    const countEl = $("count");
    const updatedAtEl = $("updatedAt");
    const searchEl = $("search");

    const modalBg = $("modalBg");
    const modalTitle = $("modalTitle");
    const modalDesc = $("modalDesc");
    const modalHint = $("modalHint");
    const cancelBtn = $("cancelBtn");
    const confirmBtn = $("confirmBtn");

    let raw = [];      // ì „ì²´
    let view = [];     // í•„í„°ëœ ëª©ë¡
    let pendingAction = null;

    function fmtTime(ts) {
      if (!ts) return "unknown";
      try {
        const d = new Date(ts);
        if (isNaN(d.getTime())) return "unknown";
        return d.toLocaleString();
      } catch {
        return "unknown";
      }
    }

    function escapeHtml(s) {
      return (s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function openModal({ title, desc, hint, dangerText, onConfirm }) {
      modalTitle.textContent = title || "í™•ì¸";
      modalDesc.textContent = desc || "ì§„í–‰í• ê¹Œ?";
      modalHint.textContent = hint || "";
      confirmBtn.textContent = dangerText || "ì§„í–‰";
      pendingAction = onConfirm;
      modalBg.style.display = "flex";
    }

    function closeModal() {
      modalBg.style.display = "none";
      pendingAction = null;
    }

    cancelBtn.addEventListener("click", closeModal);
    modalBg.addEventListener("click", (e) => {
      if (e.target === modalBg) closeModal();
    });
    confirmBtn.addEventListener("click", async () => {
      if (!pendingAction) return closeModal();
      try {
        await pendingAction();
      } finally {
        closeModal();
      }
    });

    function applyFilter() {
      const q = (searchEl.value || "").trim().toLowerCase();
      if (!q) {
        view = [...raw];
      } else {
        view = raw.filter(item => {
          const hay = [
            item.text,
            (item.tags || []).join(" "),
            item.reason,
            item.source?.room,
            item.source?.page,
          ].filter(Boolean).join(" ").toLowerCase();
          return hay.includes(q);
        });
      }
      render();
    }

    function render() {
      countEl.textContent = String(view.length);
      listEl.innerHTML = "";

      if (view.length === 0) {
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";

      view.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";

        const reasonBadge = item.reason
          ? `<span class="badge danger">ì‚¬ìœ : ${escapeHtml(item.reason)}</span>`
          : `<span class="badge">ì‚¬ìœ : ë¯¸ê¸°ì¬</span>`;

        const tags = (item.tags && item.tags.length)
          ? item.tags.map(t => `<span class="badge">#${escapeHtml(t)}</span>`).join(" ")
          : `<span class="badge">#untagged</span>`;

        const when = fmtTime(item.movedAt || item.createdAt);

        card.innerHTML = `
          <div class="metaRow" style="margin-top:0;">
            <span class="badge">ì •í™”í†µ Â· ${escapeHtml(item.id || "unknown")}</span>
            <span class="badge">${escapeHtml(when)} Â· ${escapeHtml(item.source?.room || "unknown")}</span>
            ${reasonBadge}
          </div>

          <div style="margin-top:12px; font-size:18px; line-height:1.5; color:#e8eaf0;">
            ${escapeHtml(item.text || "")}
          </div>

          <div class="metaRow" style="margin-top:12px;">
            ${tags}
          </div>

          <div class="row" style="margin-top:14px;">
            <button class="ghost" data-action="restore" data-id="${escapeHtml(item.id)}">ìˆ¨ìœ¼ë¡œ ë³µì›</button>
            <button data-action="send" data-id="${escapeHtml(item.id)}">íšŒì˜ë¡œ ë³´ë‚´ê¸°</button>
            <button class="btnDanger" data-action="delete" data-id="${escapeHtml(item.id)}" title="ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ">ì˜êµ¬ ì‚­ì œ</button>
          </div>
        `;

        listEl.appendChild(card);
      });
    }

    async function load() {
      try {
        const res = await fetch(DATA_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("fetch failed");
        const data = await res.json();

        // ê¸°ëŒ€ êµ¬ì¡°:
        // {
        //   "version": 1,
        //   "updatedAt": "2025-12-16T04:00:00Z",
        //   "items": [ { id, text, tags, reason, movedAt, source } ]
        // }
        raw = Array.isArray(data?.items) ? data.items : [];
        updatedAtEl.textContent = fmtTime(data?.updatedAt);
        applyFilter();
      } catch (e) {
        raw = [];
        updatedAtEl.textContent = "ë¡œë“œ ì‹¤íŒ¨";
        listEl.innerHTML = `
          <div class="card">
            <div class="subtitle" style="margin:0;">
              ì •í™”í†µ ë°ì´í„°ë¥¼ ëª» ë¶ˆëŸ¬ì™”ì–´.
            </div>
            <div class="muted" style="margin-top:10px;">
              ì§€ê¸ˆì€ <b>${escapeHtml(DATA_URL)}</b> ë¥¼ ì½ê²Œ ë˜ì–´ìˆì–´. <br/>
              1) íŒŒì¼ì„ ë§Œë“¤ê±°ë‚˜(ì˜ˆ: public/data/purify-bin.json) <br/>
              2) ì„œë²„ APIë¡œ êµì²´í•˜ë©´ ë¼. (ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ë¶™ì´ì)
            </div>
          </div>
        `;
      }
    }

    // ë²„íŠ¼ ì´ë²¤íŠ¸(ê³¨ê²©)
    listEl.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const action = btn.dataset.action;
      const id = btn.dataset.id;
      if (!action || !id) return;

      if (action === "restore") {
        openModal({
          title: "ìˆ¨ìœ¼ë¡œ ë³µì›",
          desc: "ì´ ì–¸ì–´ë¥¼ ì •í™”í†µì—ì„œ êº¼ë‚´ì„œ ìˆ¨(ì €ì¥ì†Œ)ë¡œ ë˜ëŒë¦´ê¹Œ?",
          hint: "ë˜ëŒë¦° ë’¤ì—ë„ í•„ìš”í•˜ë©´ ë‹¤ì‹œ ì ê¹ ë‘˜ ìˆ˜ ìˆì–´.",
          dangerText: "ë³µì›",
          onConfirm: async () => {
            // TODO: API ë¶™ì´ë©´ ì—¬ê¸°ì—ì„œ ì„œë²„ í˜¸ì¶œ
            raw = raw.filter(x => String(x.id) !== String(id));
            applyFilter();
          }
        });
      }

      if (action === "send") {
        openModal({
          title: "íšŒì˜ë¡œ ë³´ë‚´ê¸°",
          desc: "ì´ ì–¸ì–´ë¥¼ íšŒì˜ë¡œ ë‹¤ì‹œ ì˜¬ë¦´ê¹Œ?",
          hint: "ì¤‘ë³µ/ì¡ìŒì´ë©´ íšŒì˜ ì „ì— í•œ ë²ˆ ë” ë‹¤ë“¬ëŠ” ê²ƒë„ ì¢‹ì•„.",
          dangerText: "ë³´ë‚´ê¸°",
          onConfirm: async () => {
            // TODO: API ë¶™ì´ë©´ ì„œë²„ í˜¸ì¶œ
            raw = raw.filter(x => String(x.id) !== String(id));
            applyFilter();
          }
        });
      }

      if (action === "delete") {
        openModal({
          title: "ì˜êµ¬ ì‚­ì œ",
          desc: "ì§„ì§œë¡œ ì™„ì „íˆ ì§€ìš¸ê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ì–´)",
          hint: "ê°€ëŠ¥í•˜ë©´: 1) ì •í™”í†µ â†’ 2) í™•ì¸ â†’ 3) í•˜ë“œ ì‚­ì œ. ì´ ë‹¨ê³„ê°€ ì•ˆì „í•´.",
          dangerText: "ì˜êµ¬ ì‚­ì œ",
          onConfirm: async () => {
            // TODO: API ë¶™ì´ë©´ DELETE í˜¸ì¶œ
            raw = raw.filter(x => String(x.id) !== String(id));
            applyFilter();
          }
        });
      }
    });

    $("reloadBtn").addEventListener("click", load);

    $("emptyBtn").addEventListener("click", () => {
      if (raw.length === 0) return;
      openModal({
        title: "ì •í™”í†µ ì „ì²´ ì˜êµ¬ ì‚­ì œ",
        desc: `ì •í™”í†µì˜ ${raw.length}ê°œë¥¼ ëª¨ë‘ ì˜êµ¬ ì‚­ì œí• ê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ì–´)`,
        hint: "ì´ê±´ ë§ˆì§€ë§‰ ë‹¨ê³„ì—ì„œë§Œ ì“°ëŠ” ê²Œ ì¢‹ì•„.",
        dangerText: "ì „ì²´ ì‚­ì œ",
        onConfirm: async () => {
          // TODO: API ë¶™ì´ë©´ ì„œë²„ì—ì„œ ë¹„ìš°ê¸°
          raw = [];
          applyFilter();
        }
      });
    });

    searchEl.addEventListener("input", applyFilter);

    // init
    load();
  </script>
</body>
</html>
