<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>meeting</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#111b2e;
      --card: rgba(255,255,255,0.06);
      --line: rgba(255,255,255,0.12);
      --text:#e5e7eb;
      --muted:rgba(229,231,235,0.75);
      --blue:#60a5fa;
      --ok:#34d399;
      --warn:#f59e0b;
      --danger:#fb7185;
    }
    body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    a{color:var(--blue); text-decoration:none;}
    .wrap{max-width:920px; margin:18px auto; padding:0 14px;}
    .top{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:14px;}
    .title{font-size:22px; font-weight:800;}
    .sub{color:var(--muted); font-size:13px;}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border:1px solid var(--line); border-radius:16px; padding:16px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .btn{
      appearance:none; border:1px solid var(--line);
      background:var(--card); color:var(--text);
      padding:10px 12px; border-radius:999px;
      font-weight:800; cursor:pointer;
    }
    .btn:hover{border-color:rgba(255,255,255,0.22);}
    .btn.primary{background:rgba(96,165,250,0.18); border-color:rgba(96,165,250,0.35);}
    .btn.ok{background:rgba(52,211,153,0.14); border-color:rgba(52,211,153,0.35);}
    .status{margin-top:10px; color:var(--muted); font-size:13px;}
    .h{margin:16px 0 8px; font-weight:900; letter-spacing:-0.2px;}
    .cand{
      margin-top:10px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .tag{font-size:12px; color:var(--muted); margin-bottom:6px;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;}
    .pre{
      white-space:pre-wrap;
      word-break:break-word;
      line-height:1.7;
      font-size:15px;
      color:var(--text);
    }
    .split{display:grid; grid-template-columns: 1fr; gap:12px;}
    @media (min-width: 900px){
      .split{grid-template-columns: 1.2fr 0.8fr;}
    }
    .box{
      background:rgba(0,0,0,0.18);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    input, textarea{
      width:100%;
      background:rgba(0,0,0,0.22);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:160px; resize:vertical;}
    .mini{font-size:12px; color:var(--muted);}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">회의</div>
        <div class="sub">언어가 모이면, 우리는 합의점을 찾고 미래형 문장을 만들지.</div>
      </div>
      <div class="row">
        <a class="btn" href="/console.html">← 메인</a>
      </div>
    </div>

    <div class="panel">
      <div class="row">
        <button class="btn primary" id="btnReload">새로고침</button>
        <button class="btn ok" id="btnPromote">중앙기억으로 승격</button>
        <a class="btn" href="/central-memory.html">중앙기억 보기</a>
      </div>
      <div class="status" id="status">대기 중…</div>

      <div class="split" style="margin-top:14px;">
        <div class="box">
          <div class="h">회의 본문</div>
          <div class="mini">아래 텍스트가 “승격 카드 body”로 저장돼.</div>
          <textarea id="meetingBody" placeholder="회의 언어가 여기에 보여야 해."></textarea>
        </div>
        </div>

<script>
  const AUTO_MODE = true;
const RETURN_TO_APP = true;

 function getParam(name) {
  const u = new URL(location.href);
  return u.searchParams.get(name);
}
  const LOCAL_MEETINGS_KEY = "harulua.meetings";
  const LAST_MEETING_KEY   = "harulua.lastMeetingId";

  const CENTRAL_LOCAL_KEY  = "harulua.central.definitions.local"; // { items:[...] }
  const LAST_DEF_KEY       = "harulua.central.lastDefinitionId";

  function setStatus(msg){
    const el = document.getElementById("status");
    if(el) el.textContent = msg;
    console.log("[meeting]", msg);
  }

  function safeJsonParse(v, fallback){
    try { return JSON.parse(v); } catch { return fallback; }
  }

  function writeJson(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }

  function nowId(prefix){
    return `${prefix}-${Date.now()}-${Math.floor(Math.random()*100000)}`;
  }

  function pickTitleFromText(t){
    const s = (t||"").trim();
    if(!s) return "무제";
    const firstLine = s.split("\n").map(x=>x.trim()).filter(Boolean)[0] || "무제";
    return firstLine.length > 18 ? (firstLine.slice(0,18) + "…") : firstLine;
  }

  function loadLocalMeeting(id){
    const raw = localStorage.getItem(LOCAL_MEETINGS_KEY);
    const store = safeJsonParse(raw, null);
    if(!store) return null;

    if(!Array.isArray(store) && typeof store === "object" && store[id]) {
      return store[id];
    }
    if(!Array.isArray(store) && typeof store === "object" && Array.isArray(store.items)) {
      return store.items.find(m => m && m.id === id) || null;
    }
    if(Array.isArray(store)) {
      return store.find(m => m && m.id === id) || null;
    }
    return null;
  }

  let currentMeetingId = null;
  let currentMeeting = null;

  function resolveMeetingId(){
    const q = getParam("id");
    if(q) return q;
    const last = localStorage.getItem(LAST_MEETING_KEY);
    if(last) return last;
    return null;
  }

  function loadMeeting(){
    const id = resolveMeetingId();
    currentMeetingId = id;

    if(!id){
      setStatus("meetingId가 없어. breath-language → meeting 흐름에서 lastMeetingId가 먼저 저장돼야 해.");
      return;
    }

    const m = loadLocalMeeting(id);
    if(!m){
      setStatus("로컬 meetings에 해당 meeting이 없어. (harulua.meetings 확인)");
      return;
    }

    currentMeeting = m;
    localStorage.setItem(LAST_MEETING_KEY, id);

    const bodyEl = document.getElementById("meetingBody");
  const rawBody = (m.body || m.text || m.summary || m.oneLiner || "").toString();

// ✅ 기호(-, •) 제거 + 라인 정리
const cleanedBody = rawBody
  .split("\n")
  .map(l => l.replace(/^[-•]\s*/, "").trim())
  .filter(Boolean)
  .join("\n");

bodyEl.value = cleanedBody;


    setStatus("회의 로드 완료 (본문만)");
  }

  // ✅ 질문 풀(회의 → 중앙기억 승격 시 사용)
const QUESTION_POOL = [
  "너의 미래를 위해, 지금 어떤 꿈을 꾸고 있어?",
  "우리가 바라는 행복은, 어떤 모습일까?",
  "지금의 선택은, 너를 어디로 데려가고 있을까?",
  "이 언어가 향하는 미래에는, 어떤 삶이 기다리고 있을까?",
  "지금 붙잡은 이 감각은, 계속 가져가고 싶은 걸까?",
  "너는 지금 멈춘 걸까, 다른 속도로 흐르고 있는 걸까?",
  "지금의 너에게 가장 필요한 건 무엇일까?",
  "이 문장을 오늘 하루에 쓴다면, 무엇이 달라질까?",
  "함께 간다는 건, 무엇을 덜 가져가는 일일까?",
  "이 질문은, 너를 어디로 움직이게 할까?"
];
let lastQuestion = null;

function pickRandomQuestion(){
  let q;

  do {
    q = QUESTION_POOL[Math.floor(Math.random() * QUESTION_POOL.length)];
  } while (q === lastQuestion && QUESTION_POOL.length > 1);

  lastQuestion = q;
  return q;
}
async function promoteToCentral(){
  // ✅ 자동 승격 중복 방지: 같은 meetingId는 1번만 승격
const promoteLockKey = `harulua.autoflow.promoted.${currentMeetingId || "no-meeting"}`;
if (localStorage.getItem(promoteLockKey)) {
  setStatus("이미 승격했어(중복 방지) ✓");
  return;
}
localStorage.setItem(promoteLockKey, "1");
  const body = document.getElementById("meetingBody").value.trim();

  let question = null;
  if(body.length <= 800){
    question = pickRandomQuestion();
  }

  const title = pickTitleFromText(body);
  const topic = (currentMeeting?.topic || "무제").toString();

  // 1) 로컬 중앙기억 저장(기존 유지)
  const store = safeJsonParse(localStorage.getItem(CENTRAL_LOCAL_KEY), { items: [] });
  if(!Array.isArray(store.items)) store.items = [];

  const id = nowId("d");
  const item = {
    id,
    title,
    topic,
    body,
    question,
    promotedAt: new Date().toISOString(),
    meta: { from: "meeting", meetingId: currentMeetingId }
  };

  store.items.unshift(item);
  writeJson(CENTRAL_LOCAL_KEY, store);
  localStorage.setItem(LAST_DEF_KEY, id);

  // 2) core 서버에도 승격 저장
  try{
    await fetch("/api/central/promote", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
        meetingId: currentMeetingId,
        text: body,
        summary: title,
        topic
      })
    });
  }catch(e){
    console.warn("central promote api failed", e);
  }

  setStatus("승격 완료 ✓");

  const nextUrl = `/central-memory.html?id=${encodeURIComponent(id)}`;

  // 3) auto 복귀 모드면: 웹 상세로 이동 → 앱 깨우기
 if (AUTO_MODE && RETURN_TO_APP) {
  const deepLink = `harurua://central?definitionId=${encodeURIComponent(id)}`;

  window.location.href = nextUrl;

  setTimeout(() => {
    window.location.href = deepLink;
  }, 400);

  return;
}


  // 일반 모드면 웹만 이동
  window.location.href = nextUrl;
}

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("btnReload").addEventListener("click", loadMeeting);
  document.getElementById("btnPromote").addEventListener("click", promoteToCentral);

  loadMeeting();

  if (AUTO_MODE) {
    setTimeout(() => {
      const v = (document.getElementById("meetingBody")?.value || "").trim();
      if (!v) return;
      promoteToCentral();
    }, 250);
  }
});


</script>

</body>
</html>
