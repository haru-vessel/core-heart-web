<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>breath-bridge</title>
  <style>
    body{
      font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:#0b1220;
      color:#e6eefc;
      margin:0;
      padding:24px;
    }
    .box{
      max-width:720px;
      margin:0 auto;
      background:#101b33;
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:18px;
    }
    .mono{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:13px;
      opacity:.95;
      white-space:pre-wrap;
      line-height:1.5;
    }
    .dim{opacity:.7}
  </style>
</head>
<body>
  <div class="box">
    <h2 style="margin:0 0 10px 0;">ğŸŒ‰ breath-bridge</h2>
    <div class="mono" id="log">ë¸Œë¦¬ì§€ê°€ ìˆ¨ì„ ê³ ë¥´ê³  ìˆì–´â€¦</div>
    <div class="dim" style="margin-top:12px;">
      (ì˜ë¯¸êµì°¨ â†’ ì‚¬ìœ ë°©ìœ¼ë¡œ ê°€ëŠ” ì¤‘ê°„ ì–´ëŒ‘í„°)
    </div>
  </div>

<script>
/* =========================================================
 * breath-bridge
 * ì—­í• :
 * 1) meaning-crossì—ì„œ ë§Œë“  payloadë¥¼ ë°›ëŠ”ë‹¤
 * 2) thinking inboxì— 1íšŒ push
 * 3) í•´ë‹¹ ì‚¬ìœ ë°©(/thinking/{room}.html)ìœ¼ë¡œ ì´ë™
 * ========================================================= */

const INBOX_KEY   = "harulua.thinking.inbox";        // âœ… ì (.)ìœ¼ë¡œ í†µì¼
const PAYLOAD_KEY = "harulua.breathBridge.payload";  // ì˜ë¯¸êµì°¨ë°© â†’ ë¸Œë¦¬ì§€
const ACTIVE_ROUND_KEY = "harulua.round.active";
const ROUND_META_KEY   = "harulua.round.meta";
const BREATH_SEEDS_KEY = "harulua.breath.seeds";   // ë¼ìš´ë“œ ì‹œì‘ ì‹œ ì²­ì†Œìš©

/* ---------- util ---------- */
function log(msg){
  const el = document.getElementById("log");
  el.textContent += "\n" + msg;
  console.log("[breath-bridge]", msg);
}

function safeJSON(raw, fallback){
  try{ return JSON.parse(raw); }catch{ return fallback; }
}

function readJSON(key, fallback){
  const raw = localStorage.getItem(key);
  if(!raw) return fallback;
  return safeJSON(raw, fallback);
}

function writeJSON(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

function newRoundId(){
  return "round-" + Date.now() + "-" + Math.floor(Math.random() * 100000);
}

function nowId(){
  return "bx-" + Date.now() + "-" + Math.floor(Math.random()*100000);
}

function normalizeRoom(room){
  return String(room || "")
    .trim()
    .toLowerCase()
    .replace(/_+$/g,"")
    .replace(/[^a-z0-9-]/g,"");
}

/* ---------- inbox ---------- */
function ensureInbox(){
  const inbox = readJSON(INBOX_KEY, []);
  if(!Array.isArray(inbox)){
    writeJSON(INBOX_KEY, []);
    return [];
  }
  return inbox;
}

function pushInbox(item){
  const inbox = ensureInbox();
  inbox.push(item);
  writeJSON(INBOX_KEY, inbox);
  return inbox.length;
}

/* ---------- main ---------- */
(function main(){
  log("ğŸ” payload í™•ì¸ ì¤‘â€¦");

  const payload = readJSON(PAYLOAD_KEY, null);

  if(!payload){
    log("âŒ payload ì—†ìŒ â†’ íšŒì˜ëŒ€ê¸°ë¡œ ë³µê·€");
    location.href = "/meeting-room.html";
    return;
  }

 
  const text = String(payload.text || "").trim();
const mode =
  payload.mode ||
  (Array.isArray(payload.rooms) && payload.rooms.length ? "broadcast" : "single");

// room í›„ë³´ë“¤: room / rid / rooms[...]
const normRooms = (payload.rooms || [])
  .map(normalizeRoom)
  .filter(Boolean);

const singleRoom = normalizeRoom(payload.room || payload.rid || "");

// ìµœì¢… ëŒ€ìƒ ë°© ë¦¬ìŠ¤íŠ¸
const targets =
  mode === "broadcast"
    ? normRooms
    : (singleRoom ? [singleRoom] : []);

  // ===== í†µí•© ì²˜ë¦¬: targets ê¸°ì¤€ìœ¼ë¡œ push + ì´ë™ =====
if (!targets.length || !text) {
  log("âŒ payload ë‚´ìš© ë¶ˆì™„ì „");
  log(JSON.stringify(payload, null, 2));
  location.href = "/meeting-room.html";
  return;
}

log("âœ… ëŒ€ìƒ ë°© ìˆ˜: " + targets.length);
log("âœ‰ï¸ í…ìŠ¤íŠ¸ ê¸¸ì´: " + text.length);

// payload ê³µí†µ ë¶€ê°€ í•„ë“œ
const headline = payload.headline || "";
const lead = payload.lead || "";
const raw = payload.raw || "";
const refs = Array.isArray(payload.refs) ? payload.refs : [];
const from = payload.from || "meaning-cross";
const createdAt = new Date().toISOString();

// âœ… ë¼ìš´ë“œ ì‹œì‘ì : 13ê°œë¡œ í¼ì§€ëŠ” ìˆœê°„(broadcast)
// - ìƒˆ ë¼ìš´ë“œë¥¼ ë§Œë“¤ê³ 
// - ì´ì „ ì°Œêº¼ê¸°(seeds/bundle)ë¥¼ ì •ë¦¬í•´ì„œ ì„ì„/ê²½í•©ì„ ë§‰ëŠ”ë‹¤
let roundId = localStorage.getItem(ACTIVE_ROUND_KEY) || "";

if (mode === "broadcast") {
  roundId = newRoundId();
  localStorage.setItem(ACTIVE_ROUND_KEY, roundId);

  // ë¼ìš´ë“œ ë©”íƒ€(ë””ë²„ê¹…/ì¶”ì ìš©)
  localStorage.setItem(ROUND_META_KEY, JSON.stringify({
    roundId,
    from,
    headline,
    lead,
    createdAt
  }));

  // âœ… ì´ì „ ë¼ìš´ë“œ ì°Œêº¼ê¸° ì •ë¦¬(ì„ì„ ë°©ì§€)
  localStorage.removeItem(BREATH_SEEDS_KEY);
  localStorage.removeItem("breath-bundle");
}

// ê° ë°© inboxì— push
targets.forEach((room) => {
  const item = {
    id: nowId(),
    room,           // âœ… thinking-coreê°€ ì†Œë¹„í•˜ëŠ” ê¸°ì¤€
    roundId,
    text,
    headline,
    lead,
    raw,
    refs,
    from,
    createdAt
  };
  pushInbox(item);
});

log("ğŸ“¥ inbox push ì™„ë£Œ");

// payload 1íšŒ ì†Œë¹„
localStorage.removeItem(PAYLOAD_KEY);
log("ğŸ§¹ payload ì†Œë¹„ ì™„ë£Œ");

// âœ… ëŒ€ìƒ ë°©ì´ 1ê°œë©´ ë°”ë¡œ ì‚¬ìœ ë°©ìœ¼ë¡œ
if (targets.length === 1) {
  const only = targets[0] || "haru";
  const nextUrl = "/thinking/" + only + ".html?rid=" + encodeURIComponent(only);
  log("â¡ ì´ë™(ë‹¨ì¼): " + nextUrl);
  setTimeout(() => { location.href = nextUrl; }, 250);
  return;
}

// âœ… ì—¬ëŸ¬ ê°œë©´ ê³µëª… ë¸Œë¦¿ì§€ë¡œ (ì™„ì „ ë¬´ì¸ ìë™í™”)
const nextUrl = "/resonance-bridge.html?auto=1";
log("â¡ ìë™ ì´ë™(ë‹¤ì¤‘): " + nextUrl);
setTimeout(() => { location.href = nextUrl; }, 250);
return;


})();
</script>
</body>
</html>
